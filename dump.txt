PROJECT DUMP (2026-01-19T14:53:25)
ROOT: D:/dfmea_v6_frontendmockup/dfmea_v6_frontendmockup
EXCLUDES: (none)


==========================================================================================
FILE: app/page.js
==========================================================================================
// app/page.js
"use client";

import { useMemo, useState } from "react";
import TopNav from "../components/TopNav";
import Sidebar from "../components/Sidebar";
import Workspace from "../components/Workspace";

import requirementsJson from "../data/requirements.json";
import processDiagram from "../data/processDiagram.json";
import rootCauseAnalysis from "../data/rootCauseAnalysis.json";
import workflowsJson from "../data/workflows.json";

import { DFMEAProvider, useDFMEA } from "../contexts/Context";

function AppShell({ requirementsData, setRequirementsData }) {
  const tabs = useMemo(
    () => [
      { id: "requirements", label: "Requirements" },
      { id: "processDiagram", label: "Process Diagram" },
      { id: "rootCauseAnalysis", label: "Root Cause Analysis" }
    ],
    []
  );

  const { activeTab, setActiveTab } = useDFMEA();

  const tabDataMap = useMemo(
    () => ({
      requirements: requirementsData,
      processDiagram,
      rootCauseAnalysis,
      workflows: workflowsJson
    }),
    [requirementsData]
  );

  const tabData = tabDataMap[activeTab] ?? tabDataMap.requirements;

  const [activeSheetTab, setActiveSheetTab] = useState("requirements");

  const requirementsUnlocked = useMemo(() => {
    const reqs = requirementsData?.content?.requirements ?? [];
    if (!reqs.length) return false;
    const allComplete = reqs.every((r) => !!r.isComplete);
    const noneFlagged = reqs.every((r) => !r.flagged);
    return allComplete && noneFlagged;
  }, [requirementsData]);

  // local dev gating (unchanged)
  const [devOverride, setDevOverride] = useState(false);
  const [listViewUnlocked, setListViewUnlocked] = useState(false);

  const canAccessOtherTabs = requirementsUnlocked || devOverride || listViewUnlocked;

  function handleChangeTab(nextTabId) {
    // ✅ Workflows always accessible and DOES NOT affect TopNav indicator
    if (nextTabId === "workflows") {
      setActiveTab("workflows");
      return;
    }

    if (nextTabId !== "requirements" && !canAccessOtherTabs) return;

    setActiveTab(nextTabId);
    setActiveSheetTab(nextTabId);
  }

  function onUpdateRequirements(nextRequirementsArray) {
    setRequirementsData((prev) => ({
      ...prev,
      content: {
        ...prev.content,
        requirements: nextRequirementsArray
      }
    }));
  }

  return (
    <div className="h-screen bg-[#fbfbfa] text-zinc-900 antialiased">
      <div className="lg:hidden h-screen flex items-center justify-center p-8">
        <div className="max-w-md text-center">
          <div className="text-xl font-semibold tracking-tight">Desktop required</div>
          <div className="mt-2 text-sm text-zinc-600">
            This mock UI is designed strictly for desktop layouts.
          </div>
        </div>
      </div>

      <div className="hidden lg:flex h-full flex-col overflow-hidden">
        <TopNav
          tabs={tabs}
          activeTab={activeSheetTab}
          onChangeTab={handleChangeTab}
          unlockSheets={canAccessOtherTabs}
        />

        <div className="flex flex-1 overflow-hidden">
          <Sidebar tasksTitle={tabData?.tasksTitle} tasks={tabData?.tasks} />

          <Workspace
            tabData={tabData}
            onUpdateRequirements={onUpdateRequirements}
            requirementsUnlocked={requirementsUnlocked}
            devOverride={devOverride}
            onDevSetOverride={setDevOverride}
            onListViewUnlock={() => setListViewUnlocked(true)}
          />
        </div>
      </div>
    </div>
  );
}

export default function Page() {
  const [requirementsData, setRequirementsData] = useState(requirementsJson);

  return (
    <DFMEAProvider initialWorkflows={workflowsJson?.content?.workflows ?? []}>
      <AppShell requirementsData={requirementsData} setRequirementsData={setRequirementsData} />
    </DFMEAProvider>
  );
}


==========================================================================================
FILE: components/AiDock.js
==========================================================================================
// components/AiDock.js
"use client";

import { useEffect, useRef, useState } from "react";
import {
  ChevronDown,
  Maximize2,
  Expand,
  Plus,
  ArrowUp,
  Loader2
} from "lucide-react";

const cx = (...c) => c.filter(Boolean).join(" ");

/* ----------------------------- Shadows (different recipes) ----------------------------- */
const SH_DOCK =
  "shadow-[0_1px_0_rgba(0,0,0,0.06),0_30px_70px_rgba(0,0,0,0.16)]";

export default function AiDock({ tabData }) {
  const [input, setInput] = useState("");
  const [messages, setMessages] = useState([]);
  const [dockOpen, setDockOpen] = useState(false);
  const [dockSize, setDockSize] = useState("sm"); // sm | md | lg
  const [fullscreen, setFullscreen] = useState(false);
  const listRef = useRef(null);

  useEffect(() => {
    setInput("");
    setMessages([{ role: "assistant", text: tabData.assistant.welcome }]);
  }, [tabData.tabId, tabData.assistant.welcome]);

  useEffect(() => {
    const el = listRef.current;
    if (!el) return;
    el.scrollTop = el.scrollHeight;
  }, [messages, dockOpen, dockSize, fullscreen]);

  function send(text) {
    const trimmed = text.trim();
    if (!trimmed) return;

    setMessages((m) => [
      ...m,
      { role: "user", text: trimmed },
      {
        role: "assistant",
        text:
          "Mock response. Wire this to your LLM later (and pass selected DFMEA context / viewport data)."
      }
    ]);

    setInput("");
    setDockOpen(true); // when you send, show the conversation
  }

  function cycleSize() {
    setDockSize((s) => (s === "sm" ? "md" : s === "md" ? "lg" : "sm"));
    setDockOpen(true);
  }

  const heightClass =
    dockSize === "sm" ? "h-44" : dockSize === "lg" ? "h-[520px]" : "h-64";

  const Shell = ({ children, className = "" }) => (
    <div
      className={cx(
        "rounded-2xl border border-zinc-200/80 bg-white overflow-hidden",
        SH_DOCK,
        className
      )}
    >
      {children}
    </div>
  );

  const PromptChips = () =>
    tabData.assistant?.suggestedPrompts?.length ? (
      <div className="px-4 pb-3 bg-white">
        <div className="flex flex-wrap gap-2">
          {tabData.assistant.suggestedPrompts.map((p) => (
            <button
              key={p}
              onClick={() => send(p)}
              className="text-[11px] px-2.5 py-1 rounded-full bg-zinc-100 hover:bg-zinc-200/70 border border-zinc-200/80 text-zinc-700 transition-colors"
            >
              {p}
            </button>
          ))}
        </div>
      </div>
    ) : null;

  const Messages = () => (
    <div
      ref={listRef}
      className={cx("overflow-y-auto px-4 py-4 space-y-3 bg-[#fbfbfa]", heightClass)}
    >
      {messages.map((m, idx) => (
        <div
          key={idx}
          className={cx(
            "max-w-[85%] rounded-2xl px-3 py-2 text-[13px] leading-relaxed tracking-tight",
            m.role === "user"
              ? "ml-auto bg-zinc-900 text-white"
              : "bg-white border border-zinc-200/80 text-zinc-800"
          )}
        >
          {m.text}
        </div>
      ))}
    </div>
  );

  // ChatGPT-like composer: centered, small, always usable
  const CompactComposer = ({ compact }) => (
    <div className={cx("bg-white", compact ? "p-3" : "p-3 border-t border-zinc-200/70")}>
      <div className="flex items-center gap-2 rounded-2xl border border-zinc-200/80 bg-white px-3 py-2">
        <button
          type="button"
          className="h-8 w-8 rounded-full grid place-items-center hover:bg-zinc-100 transition-colors"
          aria-label="Attach"
        >
          <Plus size={16} strokeWidth={1.8} className="text-zinc-700" />
        </button>

        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={(e) => e.key === "Enter" && send(input)}
          className="flex-1 text-[13px] tracking-tight outline-none placeholder:text-zinc-400"
          placeholder="Ask anything…"
        />

        <button
          type="button"
          onClick={() => send(input)}
          className={cx(
            "h-8 w-8 rounded-full grid place-items-center",
            input.trim()
              ? "bg-zinc-900 hover:bg-zinc-800"
              : "bg-zinc-200 cursor-not-allowed",
            "transition-colors"
          )}
          aria-label="Send"
          disabled={!input.trim()}
        >
          <ArrowUp size={16} strokeWidth={2.2} className="text-white" />
        </button>
      </div>

      {compact ? (
        <div className="mt-2 flex items-center justify-between">
          <button
            onClick={() => setDockOpen(true)}
            className="text-[11px] text-zinc-600 hover:text-zinc-900 transition-colors"
          >
            Open chat
          </button>
          <div className="text-[11px] text-zinc-500">
            AI Assistant • {tabData.title}
          </div>
        </div>
      ) : (
        <div className="mt-2 text-[11px] text-zinc-500">
          Tip: later you can add “Send selection to AI” from the viewport.
        </div>
      )}
    </div>
  );

  const Fullscreen = () => {
    if (!fullscreen) return null;

    return (
      <div className="fixed inset-0 z-50">
        <div
          className="absolute inset-0 bg-zinc-950/20 backdrop-blur-sm"
          onClick={() => setFullscreen(false)}
        />
        <div className="absolute inset-0 p-6 flex">
          <div className="m-auto w-full max-w-4xl h-[80vh]">
            <Shell>
              <div className="px-4 py-3 flex items-center justify-between bg-white border-b border-zinc-200/70">
                <div>
                  <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                    AI Assistant
                  </div>
                  <div className="text-[11px] text-zinc-500">Full window • mock</div>
                </div>
                <button
                  onClick={() => setFullscreen(false)}
                  className="text-[11px] px-2 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200/70 border border-zinc-200/80 text-zinc-700 transition-colors"
                >
                  Close
                </button>
              </div>

              <PromptChips />
              <div className="h-[calc(80vh-170px)]">
                <div
                  ref={listRef}
                  className="h-full overflow-y-auto px-4 py-4 space-y-3 bg-[#fbfbfa]"
                >
                  {messages.map((m, idx) => (
                    <div
                      key={idx}
                      className={cx(
                        "max-w-[85%] rounded-2xl px-3 py-2 text-[13px] leading-relaxed tracking-tight",
                        m.role === "user"
                          ? "ml-auto bg-zinc-900 text-white"
                          : "bg-white border border-zinc-200/80 text-zinc-800"
                      )}
                    >
                      {m.text}
                    </div>
                  ))}
                </div>
              </div>
              <CompactComposer compact={false} />
            </Shell>
          </div>
        </div>
      </div>
    );
  };

  return (
    <>
      <Fullscreen />

      {/* CENTERED dock width (ChatGPT-ish) */}
      <div className="max-w-[860px] mx-auto">
        {/* Collapsed state = compact composer only, still typeable */}
        {!dockOpen ? (
          <Shell className="rounded-[26px]">
            <div className="px-4 py-2 flex items-center justify-between bg-white">
              <button
                onClick={() => setDockOpen(true)}
                className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200/70 border border-zinc-200/80 text-zinc-700 transition-colors"
                title="Expand"
              >
                <ChevronDown size={14} strokeWidth={1.7} className="rotate-180" />
                Expand
              </button>

              <div className="text-[11px] text-zinc-500">AI Assistant</div>

              <button
                onClick={() => setFullscreen(true)}
                className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 transition-colors"
                title="Full window"
              >
                <Maximize2 size={14} strokeWidth={1.7} />
                Full
              </button>
            </div>

            <CompactComposer compact />
          </Shell>
        ) : (
          <Shell>
            <div className="px-4 py-3 flex items-center justify-between bg-white border-b border-zinc-200/70">
              <div className="min-w-0">
                <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                  AI Assistant
                </div>
                <div className="text-[11px] text-zinc-500 truncate">
                  Context-aware chat (mock) • {tabData.title}
                </div>
              </div>

              <div className="flex items-center gap-1.5">
                <button
                  onClick={() => setDockOpen(false)}
                  className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200/70 border border-zinc-200/80 text-zinc-700 transition-colors"
                  title="Collapse"
                >
                  <ChevronDown size={14} strokeWidth={1.7} />
                  Collapse
                </button>

                <button
                  onClick={cycleSize}
                  className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-xl bg-zinc-100 hover:bg-zinc-200/70 border border-zinc-200/80 text-zinc-700 transition-colors"
                  title="Resize"
                >
                  <Expand size={14} strokeWidth={1.7} />
                  Size
                </button>

                <button
                  onClick={() => setFullscreen(true)}
                  className="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 transition-colors"
                  title="Full window"
                >
                  <Maximize2 size={14} strokeWidth={1.7} />
                  Full
                </button>
              </div>
            </div>

            <PromptChips />
            <Messages />
            <CompactComposer compact={false} />
          </Shell>
        )}
      </div>
    </>
  );
}


==========================================================================================
FILE: components/ProcessDiagramViewport.js
==========================================================================================
// components/ProcessDiagramViewport.js
"use client";

import ProcessForceGraph from "./ProcessForceGraph";

export default function ProcessDiagramViewport() {
  return (
    <div
      className={[
        "relative",
        // Full canvas height inside the workspace scroll area:
        // top nav is 56px, workspace header is 48px => 104px
        // this makes the graph feel full-screen.
        "h-[calc(100vh-104px)]",
        "bg-[#fbfbfa]"
      ].join(" ")}
    >
      {/* Optional tiny label (very subtle, no big title spacing) */}
      <div className="absolute left-10 top-6 z-10">
        <div className="text-[13px] font-medium tracking-tight text-zinc-900">
          Process Diagram
        </div>
        <div className="mt-1 text-[11px] text-zinc-500 tracking-tight">
          requirements → systems → functions
        </div>
      </div>

      {/* Graph fills entire viewport */}
      <div className="absolute inset-0">
        <ProcessForceGraph />
      </div>
    </div>
  );
}


==========================================================================================
FILE: components/ProcessForceGraph.js
==========================================================================================
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import dynamic from "next/dynamic";

const ForceGraph2D = dynamic(
  () => import("react-force-graph-2d").then((m) => m.default),
  { ssr: false }
);

const cx = (...c) => c.filter(Boolean).join(" ");

function useResizeObserver(ref, onResize) {
  useEffect(() => {
    const el = ref.current;
    if (!el) return;

    const ro = new ResizeObserver(() => onResize());
    ro.observe(el);
    return () => ro.disconnect();
  }, [ref, onResize]);
}

export default function ProcessForceGraph({ className = "" }) {
  const wrapRef = useRef(null);
  const fgRef = useRef(null);
  const [hoveredNode, setHoveredNode] = useState(null);

  const graphData = useMemo(() => {
    const root = { id: "req", type: "root", label: "requirements" };

    const systems = [
      { id: "sys-1", type: "system", label: "System • Power" },
      { id: "sys-2", type: "system", label: "System • Control" },
      { id: "sys-3", type: "system", label: "System • Sensing" },
      { id: "sys-4", type: "system", label: "System • Actuation" }
    ];

    const functions = [
      { id: "fn-1", type: "function", label: "Regulate voltage", sub: "Stable supply", parent: "sys-1" },
      { id: "fn-2", type: "function", label: "Limit current", sub: "Safe operation", parent: "sys-1" },

      { id: "fn-3", type: "function", label: "State machine", sub: "Predictable flow", parent: "sys-2" },
      { id: "fn-4", type: "function", label: "Fault handling", sub: "Fail-safe behavior", parent: "sys-2" },

      { id: "fn-5", type: "function", label: "Read sensors", sub: "Accuracy target", parent: "sys-3" },
      { id: "fn-6", type: "function", label: "Filter noise", sub: "Signal quality", parent: "sys-3" },

      { id: "fn-7", type: "function", label: "Drive motor", sub: "Response time", parent: "sys-4" },
      { id: "fn-8", type: "function", label: "Position control", sub: "Tight tolerance", parent: "sys-4" }
    ];

    return {
      nodes: [root, ...systems, ...functions],
      links: [
        ...systems.map((s) => ({ source: root.id, target: s.id })),
        ...functions.map((f) => ({ source: f.parent, target: f.id }))
      ]
    };
  }, []);

  // Enhanced node drawing with clear differentiation and readable text
  const drawNode = (node, ctx, globalScale) => {
    const isRoot = node.type === "root";
    const isSystem = node.type === "system";
    const isFn = node.type === "function";
    const isHovered = hoveredNode?.id === node.id;

    // Larger sizes for better spacing - increased root size
    const r = isRoot ? 38 : isSystem ? 24 : 16;

    // Draw selection/hover indicator with color accent
    if (isHovered) {
      ctx.beginPath();
      ctx.arc(node.x, node.y, r + 16, 0, 2 * Math.PI);
      ctx.fillStyle = "rgba(59, 130, 246, 0.06)"; // Blue tint
      ctx.fill();
      ctx.strokeStyle = "rgba(59, 130, 246, 0.3)";
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Node body with clear differentiation
    ctx.beginPath();

    if (isRoot) {
      // Root: solid black circle
      ctx.arc(node.x, node.y, r, 0, 2 * Math.PI);
      ctx.fillStyle = "#000000";
      ctx.fill();

      // Subtle color ring around root
      ctx.beginPath();
      ctx.arc(node.x, node.y, r + 3, 0, 2 * Math.PI);
      ctx.strokeStyle = "rgba(59, 130, 246, 0.4)";
      ctx.lineWidth = 2;
      ctx.stroke();
    } else if (isSystem) {
      // System: large white circle with LESS BOLD black border (was 4)
      ctx.arc(node.x, node.y, r, 0, 2 * Math.PI);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.lineWidth = 2; // ✅ reduced from 4
      ctx.strokeStyle = "#000000";
      ctx.stroke();
    } else {
      // Function: smaller white circle with THIN border and subtle color dot
      ctx.arc(node.x, node.y, r, 0, 2 * Math.PI);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle = "#000000";
      ctx.stroke();

      // Small color accent dot inside function nodes
      ctx.beginPath();
      ctx.arc(node.x, node.y, 4, 0, 2 * Math.PI);
      ctx.fillStyle = "rgba(59, 130, 246, 0.5)";
      ctx.fill();
    }

    // Typography - positioned BELOW nodes to avoid overlap
    const title = node.label || "";
    const sub = node.sub || "";

    ctx.textAlign = "center";
    ctx.textBaseline = "top";

    if (isRoot) {
      // Root: text inside circle
      ctx.textBaseline = "middle";
      const titleSize = 9 / globalScale;
      ctx.font = `700 ${titleSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif`;
      ctx.fillStyle = "#ffffff";
      ctx.fillText(title.toUpperCase(), node.x, node.y);
    } else if (isSystem) {
      // System: smaller text below node
      const titleSize = 11.5 / globalScale;
      const yOffset = r + 14 / globalScale;

      ctx.font = `700 ${titleSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif`;
      ctx.fillStyle = "#000000";
      ctx.fillText(title, node.x, node.y + yOffset);
    } else {
      // Function: regular weight title + subtitle below with MORE space
      const titleSize = 11 / globalScale;
      const subSize = 9 / globalScale;
      const yOffset = r + 12 / globalScale;

      // Title
      ctx.font = `500 ${titleSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif`;
      ctx.fillStyle = "#000000";
      ctx.fillText(title, node.x, node.y + yOffset);

      // Subtitle
      const subYOffset = yOffset + 14 / globalScale;
      ctx.font = `400 ${subSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif`;
      ctx.fillStyle = "#666666";
      ctx.fillText(sub, node.x, node.y + subYOffset);
    }
  };

  // Much larger hitbox for easier interaction
  const pointerPaint = (node, color, ctx) => {
    const baseR = node.type === "root" ? 38 : node.type === "system" ? 24 : 16;
    const hitboxR = baseR + 28; // Large hit area

    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(node.x, node.y, hitboxR, 0, 2 * Math.PI);
    ctx.fill();
  };

  // Configure forces with longer edges and strong elastic behavior
  useEffect(() => {
    const fg = fgRef.current;
    if (!fg) return;

    // Much stronger charge for more separation
    fg.d3Force("charge").strength(-500);

    // Link force with MUCH longer distances and high strength
    const linkForce = fg.d3Force("link");
    linkForce.distance((l) => {
      const t = typeof l.target === "object" ? l.target.type : null;
      return t === "system" ? 200 : 150; // Significantly increased
    });
    linkForce.strength(1.5); // Very strong for elastic snapback

    // Start simulation
    fg.d3ReheatSimulation();

    // Fit once after initial settle
    const id = setTimeout(() => {
      try {
        fg.zoomToFit(500, 120);
      } catch {}
    }, 500);

    return () => clearTimeout(id);
  }, []);

  // Reheat on resize only
  useResizeObserver(wrapRef, () => {
    const fg = fgRef.current;
    if (!fg) return;
    fg.d3ReheatSimulation();
  });

  const handleNodeDragEnd = (node) => {
    // Remove fixed position to allow elastic snapback
    node.fx = undefined;
    node.fy = undefined;

    // Reheat simulation for elastic effect
    const fg = fgRef.current;
    if (fg) fg.d3ReheatSimulation();
  };

  return (
    <div ref={wrapRef} className={cx("w-full h-full", className)}>
      <ForceGraph2D
        ref={fgRef}
        graphData={graphData}
        backgroundColor="#fbfbfa"
        linkColor={() => "rgba(0,0,0,0.12)"}
        linkWidth={1.5}
        linkLineDash={[6, 6]}   // ✅ dashed edges
        nodeRelSize={1}
        enableNodeDrag={true}
        warmupTicks={60}
        cooldownTicks={400}
        d3AlphaDecay={0.012}
        d3VelocityDecay={0.22}
        nodeCanvasObject={(node, ctx, globalScale) => drawNode(node, ctx, globalScale)}
        nodePointerAreaPaint={(node, color, ctx) => pointerPaint(node, color, ctx)}
        onNodeDragEnd={handleNodeDragEnd}
        onNodeHover={(node) => setHoveredNode(node)}
      />
    </div>
  );
}


==========================================================================================
FILE: components/RequirementsViewport.js
==========================================================================================
// components/RequirementsViewport.js
"use client";

import { useEffect, useMemo, useState } from "react";
import {
  Paperclip,
  CheckCircle2,
  AlertTriangle,
  Loader2,
  LayoutGrid,
  List,
  Minus,
  Plus,
  ChevronRight,
  Cpu,
  Zap,
  Wrench,
  Trash2,
  PlusCircle
} from "lucide-react";
import { useDFMEA } from "../contexts/Context";

const cx = (...c) => c.filter(Boolean).join(" ");

/* ----------------------------- Shadows ----------------------------- */
const SH_SURFACE =
  "shadow-[0_1px_0_rgba(0,0,0,0.05),0_14px_40px_rgba(0,0,0,0.06)]";
const SH_TILE =
  "shadow-[0_1px_0_rgba(0,0,0,0.05),0_10px_24px_rgba(0,0,0,0.06)]";

const ICONS = { Software: Cpu, Electrical: Zap, Mechanical: Wrench };

/* ----------------------------- UI atoms ----------------------------- */
function Surface({ className = "", children, shadow = SH_SURFACE }) {
  return (
    <div className={cx("rounded-xl border border-zinc-200/80 bg-white", shadow, className)}>
      {children}
    </div>
  );
}

function Pill({ tone = "neutral", className = "", children }) {
  const cls =
    tone === "bad"
      ? "bg-amber-50 border-amber-200/70 text-amber-900"
      : tone === "good"
        ? "bg-emerald-50 border-emerald-200/70 text-emerald-900"
        : "bg-[#fbfbfa] border-zinc-200/80 text-zinc-700";

  return (
    <span
      className={cx(
        "text-[11px] px-2 py-1 rounded-full border tracking-tight",
        cls,
        className
      )}
    >
      {children}
    </span>
  );
}

function PageTitle({ title, subtitle, rightSlot }) {
  return (
    <div className="max-w-6xl mx-auto px-10 pt-12 pb-5">
      <div className="flex items-start justify-between gap-6">
        <div className="min-w-0">
          <div className="text-[40px] leading-[1.12] font-semibold tracking-tight">
            {title}
          </div>
          {subtitle ? (
            <div className="mt-2 text-[13px] text-zinc-600 tracking-tight">{subtitle}</div>
          ) : null}
        </div>
        {rightSlot ? <div className="pt-2">{rightSlot}</div> : null}
      </div>
    </div>
  );
}

function Modal({ open, onClose, children }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-[60]">
      <div className="absolute inset-0 bg-zinc-950/20 backdrop-blur-sm" onClick={onClose} />
      <div className="absolute inset-0 p-6 flex">
        <div className="m-auto w-full max-w-5xl">
          <div className="rounded-2xl border border-zinc-200/80 bg-white overflow-hidden shadow-[0_1px_0_rgba(0,0,0,0.05),0_30px_80px_rgba(0,0,0,0.20)]">
            {children}
          </div>
        </div>
      </div>
    </div>
  );
}

function SmallBtn({ active, disabled, onClick, title, children }) {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      title={title}
      className={cx(
        "inline-flex items-center gap-1 text-[11px] px-2.5 py-1.5 rounded-xl border tracking-tight transition-colors",
        active
          ? "bg-zinc-900 text-white border-zinc-900"
          : disabled
            ? "bg-white border-zinc-200/60 text-zinc-300 cursor-not-allowed"
            : "bg-white border-zinc-200/80 text-zinc-700 hover:bg-zinc-100"
      )}
    >
      {children}
    </button>
  );
}

/* ----------------------------- Helpers ----------------------------- */
const frozen = (r) => !!r.isComplete && !r.flagged;

function ReqTypePill({ reqType }) {
  return (
    <Pill className="w-[118px] inline-flex justify-center">
      <span className="inline-flex items-center gap-1.5">
        <div className="h-1.5 w-1.5 rounded-full bg-zinc-900/70" />
        {reqType}
      </span>
    </Pill>
  );
}

function StatusIcon({ r }) {
  return frozen(r) ? (
    <CheckCircle2 size={14} strokeWidth={2} className="text-zinc-900" />
  ) : r.flagged ? (
    <AlertTriangle size={14} strokeWidth={2} className="text-zinc-900" />
  ) : (
    <AlertTriangle size={14} strokeWidth={2} className="text-zinc-600" />
  );
}

function AiChecklist({ items }) {
  const list = items?.length
    ? items
    : [
      "Add numeric acceptance criteria (values + tolerances)",
      "Include units (dB, hours, °C, V, mA, ms)",
      "Define operating conditions (mode, load, environment)",
      "Specify test method (verification approach)",
      "Clarify boundaries / edge cases (min/max, startup, aging)"
    ];

  return (
    <div className="rounded-xl border border-zinc-200/80 bg-white p-4">
      <div className="text-[11px] text-zinc-500 tracking-tight">AI checklist</div>
      <div className="mt-2 space-y-2">
        {list.map((t, idx) => (
          <label
            key={idx}
            className="flex items-start gap-3 text-[13px] tracking-tight text-zinc-800"
          >
            <input
              type="checkbox"
              defaultChecked={idx < 2}
              className="mt-0.5 h-4 w-4 accent-zinc-900"
            />
            <span>{t}</span>
          </label>
        ))}
      </div>
      <div className="mt-3 text-[11px] text-zinc-500">(Stays visible even after typing.)</div>
    </div>
  );
}

/* ----------------------------- Editor block ----------------------------- */
function Editor({
  r,
  draft,
  setDraft,
  onSave,
  saving,
  running,
  addMode,
  addText,
  setAddText,
  addError
}) {
  const busy = !!running[r.id];

  return (
    <div className="grid grid-cols-12 gap-4">
      <div className="col-span-7">
        <AiChecklist items={r.aiChecklist} />

        {addMode ? (
          <>
            <div className="mt-4 text-[11px] text-zinc-500">Requirement text</div>
            <input
              value={addText}
              onChange={(e) => setAddText(e.target.value)}
              className={cx(
                "mt-2 w-full",
                "rounded-xl border border-zinc-200/80 bg-white",
                "px-3 py-2 text-[13px] tracking-tight text-zinc-800",
                "outline-none focus:ring-2 focus:ring-zinc-300"
              )}
              placeholder="e.g. The ECU shall recover from a brownout within 200 ms at 9–16 V…"
            />
            {addError ? (
              <div className="mt-2 text-[12px] text-amber-900 bg-amber-50 border border-amber-200/70 rounded-xl px-3 py-2">
                {addError}
              </div>
            ) : null}
          </>
        ) : null}

        <div className="mt-4 text-[11px] text-zinc-500">Add missing details</div>

        <textarea
          value={draft[r.id] ?? ""}
          onChange={(e) => setDraft((p) => ({ ...p, [r.id]: e.target.value }))}
          className={cx(
            "mt-2 w-full min-h-[120px] resize-none",
            "rounded-xl border border-zinc-200/80 bg-white",
            "px-3 py-2 text-[13px] tracking-tight text-zinc-800",
            "outline-none focus:ring-2 focus:ring-zinc-300"
          )}
          placeholder="Add test method, numeric targets, conditions, tolerances, temperature range, power mode, etc…"
        />

        <div className="mt-3 flex items-center gap-2">
          <button
            onClick={() => onSave(r)}
            className={cx(
              "text-[12px] font-medium tracking-tight px-3 py-2 rounded-xl",
              "bg-zinc-900 text-white hover:bg-zinc-800 transition-colors",
              saving[r.id] && "opacity-70 cursor-not-allowed"
            )}
            disabled={!!saving[r.id]}
          >
            {busy ? (
              <span className="inline-flex items-center gap-2">
                <Loader2 size={14} strokeWidth={2} className="animate-spin" />
                {addMode ? "Adding + Risk Analysis…" : "Saving + Risk Analysis…"}
              </span>
            ) : addMode ? (
              "Add requirement"
            ) : (
              "Save"
            )}
          </button>

          <button
            className="text-[12px] font-medium tracking-tight px-3 py-2 rounded-xl bg-white border border-zinc-200/80 text-zinc-700 hover:bg-zinc-100 transition-colors cursor-not-allowed"
            disabled
            title="Mock upload"
          >
            Add file
          </button>
        </div>
      </div>

      <div className="col-span-5">
        <div className="text-[11px] text-zinc-500">Risk Analysis output</div>

        <div className="mt-2 rounded-xl border border-zinc-200/80 bg-white p-4">
          {busy ? (
            <div>
              <div className="flex items-center gap-2">
                <Loader2 size={14} strokeWidth={2} className="animate-spin text-zinc-700" />
                <div className="text-[13px] font-medium tracking-tight text-zinc-900">
                  Running Risk Analysis…
                </div>
              </div>
              <div className="mt-3 space-y-2">
                <div className="h-2.5 w-44 bg-zinc-200/70 rounded animate-pulse" />
                <div className="h-2.5 w-[92%] bg-zinc-200/70 rounded animate-pulse" />
                <div className="h-2.5 w-[80%] bg-zinc-200/70 rounded animate-pulse" />
              </div>
            </div>
          ) : r?.risk?.status ? (
            <div>
              <div className="flex items-center justify-between">
                <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                  {r.risk.title}
                </div>
                {r.risk.status === "good" ? (
                  <Pill tone="good">
                    <span className="inline-flex items-center gap-1.5">
                      <CheckCircle2 size={12} strokeWidth={2} />
                      Good
                    </span>
                  </Pill>
                ) : (
                  <Pill tone="bad">
                    <span className="inline-flex items-center gap-1.5">
                      <AlertTriangle size={12} strokeWidth={2} />
                      Flagged
                    </span>
                  </Pill>
                )}
              </div>

              <div className="mt-2 text-[13px] leading-relaxed tracking-tight text-zinc-700">
                {r.risk.reasoning}
              </div>

              <div className="mt-3 text-[11px] text-zinc-500">Last run: {r.risk.lastRun}</div>
            </div>
          ) : (
            <div>
              <div className="text-[13px] font-medium tracking-tight text-zinc-900">
                Not run yet
              </div>
              <div className="mt-2 text-[13px] leading-relaxed tracking-tight text-zinc-700">
                Add details and press <span className="font-medium">{addMode ? "Add" : "Save"}</span>.
              </div>
            </div>
          )}
        </div>

        {r.flagged && r.aiAdvice ? (
          <div className="mt-4 rounded-xl border border-zinc-200/80 bg-white p-4">
            <div className="text-[11px] text-zinc-500">AI guidance</div>
            <div className="mt-2 text-[13px] text-zinc-800 leading-relaxed tracking-tight">
              {r.aiAdvice}
            </div>
          </div>
        ) : null}
      </div>
    </div>
  );
}

/* ----------------------------- Component ----------------------------- */
export default function RequirementsViewport({ data, onUpdateRequirements, onListViewUnlock }) {

  const projectName = data?.content?.projectName ?? "DFMEA Project";
  const requirements = data?.content?.requirements ?? [];
  const changeNotices = data?.content?.changeNotices ?? [];

  const [viewMode, setViewMode] = useState("cards"); // cards | list
  const [cardSize, setCardSize] = useState("md"); // lg(2) md(3) sm(4) xs(5)
  const [showMode, setShowMode] = useState("all"); // all | unfrozen | frozen
  const [expandedId, setExpandedId] = useState(null);

  const [modalId, setModalId] = useState(null);
  const [addOpen, setAddOpen] = useState(false);
  const [addText, setAddText] = useState("");
  const [addError, setAddError] = useState("");

  const [draft, setDraft] = useState(() => {
    const m = {};
    requirements.forEach((r) => (m[r.id] = r.details ?? ""));
    return m;
  });

  const [saving, setSaving] = useState({});
  const [running, setRunning] = useState({});

  // ✅ Context: notices + requirements gating
  const {
    pushChangeNotice,
    cleanupTimers,
    setRequirementsComplete,
    unlockFromRequirementsListView,
    requirementsDevUnlocked
  } = useDFMEA();

  // reset per tab
  useEffect(() => {
    setExpandedId(null);
    setModalId(null);
    setAddOpen(false);
    setAddText("");
    setAddError("");

    const m = {};
    requirements.forEach((r) => (m[r.id] = r.details ?? ""));
    setDraft(m);
    setSaving({});
    setRunning({});
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [data?.tabId]);

  // push notices (context handles active + history)
  useEffect(() => {
    if (!changeNotices.length) return;

    let idx = 0;
    const id = setInterval(() => {
      if (idx >= Math.min(3, changeNotices.length)) {
        clearInterval(id);
        return;
      }
      pushChangeNotice(changeNotices[idx]);
      idx += 1;
    }, 3000);

    return () => {
      clearInterval(id);
      cleanupTimers?.();
    };
  }, [changeNotices, pushChangeNotice, cleanupTimers]);

  function analyze(text, details) {
    const full = `${text} ${details || ""}`.trim();
    const ok =
      /\d/.test(full) &&
      /(ms|°c|celsius|v|ma|db|hz|mm|cm|m|%|hours|hour|hr)/i.test(full) &&
      /(at|under|within|during|range|min|max|temperature|humidity|mode|load|power)/i.test(full) &&
      full.length >= 55 &&
      !/(good|nice|fast|reliable|robust|best|user friendly|should|might)/i.test(full);

    return ok
      ? {
        pass: true,
        title: "Low ambiguity • traceable",
        reasoning:
          "Requirement includes measurable targets and testable constraints (values + conditions). This reduces interpretation risk and supports DFMEA linkage."
      }
      : {
        pass: false,
        title: "High ambiguity • risk flagged",
        reasoning:
          "Risk Analysis indicates this requirement is not sufficiently testable/traceable. Add numeric targets + units + operating conditions and a clear test method."
      };
  }

  function updateAll(next) {
    onUpdateRequirements?.(next);
  }

  function updateRequirement(id, patch) {
    updateAll(requirements.map((r) => (r.id === id ? { ...r, ...patch } : r)));
  }

  function removeRequirement(id) {
    updateAll(requirements.filter((r) => r.id !== id));
  }

  function getNextId() {
    const nums = requirements
      .map((r) => String(r.id || ""))
      .map((s) => {
        const m = s.match(/REQ-(\d+)/i);
        return m ? Number(m[1]) : null;
      })
      .filter((n) => Number.isFinite(n));
    if (nums.length) {
      const next = Math.max(...nums) + 1;
      return `REQ-${String(next).padStart(3, "0")}`;
    }
    return `REQ-${String(Date.now()).slice(-6)}`;
  }

  // SAVE existing requirement (edit)
  function handleSave(req) {
    const id = req.id;
    const details = draft[id] ?? "";

    setSaving((p) => ({ ...p, [id]: true }));
    setRunning((p) => ({ ...p, [id]: true }));

    updateRequirement(id, { details, lastUpdated: "Just now" });

    setTimeout(() => {
      const res = analyze(req.text, details);

      updateRequirement(id, {
        isComplete: res.pass,
        flagged: !res.pass,
        risk: {
          status: res.pass ? "good" : "bad",
          title: res.title,
          reasoning: res.reasoning,
          lastRun: "Just now"
        }
      });

      setRunning((p) => ({ ...p, [id]: false }));
      setSaving((p) => ({ ...p, [id]: false }));
    }, 2000);
  }

  // ADD new requirement (must be complete before insert)
  function handleAddSave(tempReq) {
    const tempId = tempReq.id;
    const details = draft[tempId] ?? "";
    const text = (addText || "").trim();

    setAddError("");

    const res = analyze(text, details);

    if (!text || text.length < 8) {
      setAddError("Add a clear requirement sentence (not just a fragment).");
      return;
    }
    if (!res.pass) {
      setAddError(
        "You can’t add an incomplete requirement. Add measurable targets + units + operating conditions + test method until Risk Analysis turns Good."
      );
      return;
    }

    setSaving((p) => ({ ...p, [tempId]: true }));
    setRunning((p) => ({ ...p, [tempId]: true }));

    const newId = getNextId();
    const newReq = {
      id: newId,
      text,
      details,
      domainCategory: "Software",
      reqType: "Functional",
      priority: "Medium",
      ownerRole: "System",
      ownerName: "You",
      files: [],
      lastUpdated: "Just now",
      isComplete: true,
      flagged: false,
      risk: {
        status: "good",
        title: res.title,
        reasoning: res.reasoning,
        lastRun: "Just now"
      }
    };

    setTimeout(() => {
      updateAll([newReq, ...requirements]);

      setDraft((p) => {
        const next = { ...p };
        delete next[tempId];
        next[newId] = details;
        return next;
      });

      setSaving((p) => ({ ...p, [tempId]: false }));
      setRunning((p) => ({ ...p, [tempId]: false }));

      setAddOpen(false);
      setAddText("");
      setAddError("");
    }, 1200);
  }

  const stats = useMemo(() => {
    const total = requirements.length;
    const ok = requirements.filter((r) => frozen(r)).length;
    const flagged = requirements.filter((r) => r.flagged).length;
    return { total, frozen: ok, flagged, unfrozen: total - ok };
  }, [requirements]);

  // ✅ REAL unlock rule: requirements complete when EVERYTHING is frozen (and at least 1 exists)
  useEffect(() => {
    const done = stats.total > 0 && stats.frozen === stats.total;
    setRequirementsComplete?.(done);
  }, [stats.total, stats.frozen, setRequirementsComplete]);

  const requirementsUnlocked = (stats.total > 0 && stats.frozen === stats.total) || requirementsDevUnlocked;

  const buckets = useMemo(() => {
    const map = { Software: [], Electrical: [], Mechanical: [] };

    requirements.forEach((r) => {
      const d = r.domainCategory || "Software";
      (map[d] ??= []).push(r);
    });

    const sortReqs = (list) =>
      list.slice().sort((a, b) => {
        const au = frozen(a) ? 0 : 1;
        const bu = frozen(b) ? 0 : 1;
        if (au !== bu) return bu - au;
        const af = a.flagged ? 1 : 0;
        const bf = b.flagged ? 1 : 0;
        if (af !== bf) return bf - af;
        return String(a.id).localeCompare(String(b.id));
      });

    const meta = ["Software", "Electrical", "Mechanical"].map((d) => {
      const list = map[d] || [];
      const unfrozen = list.filter((x) => !frozen(x)).length;
      const flagged = list.filter((x) => x.flagged).length;
      return { d, unfrozen, flagged, total: list.length };
    });

    const order = meta
      .sort((a, b) => {
        if (b.unfrozen !== a.unfrozen) return b.unfrozen - a.unfrozen;
        if (b.flagged !== a.flagged) return b.flagged - a.flagged;
        return b.total - a.total;
      })
      .map((x) => x.d);

    order.forEach((d) => (map[d] = sortReqs(map[d] || [])));

    return { map, order };
  }, [requirements]);

  const filtered = useMemo(() => {
    const out = {};
    buckets.order.forEach((d) => {
      const list = buckets.map[d] || [];
      out[d] =
        showMode === "all"
          ? list
          : showMode === "frozen"
            ? list.filter((r) => frozen(r))
            : list.filter((r) => !frozen(r));
    });
    return out;
  }, [buckets, showMode]);

  const gridClass =
    cardSize === "xs"
      ? "grid grid-cols-5 gap-3"
      : cardSize === "sm"
        ? "grid grid-cols-4 gap-3"
        : cardSize === "lg"
          ? "grid grid-cols-2 gap-4"
          : "grid grid-cols-3 gap-4";

  const cardPad =
    cardSize === "xs"
      ? "p-3"
      : cardSize === "sm"
        ? "p-3.5"
        : cardSize === "lg"
          ? "p-5"
          : "p-4";

  function smaller() {
    setCardSize((s) => (s === "lg" ? "md" : s === "md" ? "sm" : "xs"));
  }
  function bigger() {
    setCardSize((s) => (s === "xs" ? "sm" : s === "sm" ? "md" : "lg"));
  }

  const modalReq = modalId ? requirements.find((r) => r.id === modalId) : null;

  const addTemp = useMemo(
    () => ({
      id: "__NEW__",
      text: addText,
      details: draft["__NEW__"] ?? "",
      reqType: "Functional",
      priority: "Medium",
      ownerRole: "System",
      ownerName: "You",
      domainCategory: "Software",
      files: [],
      flagged: false,
      isComplete: false
    }),
    [addText, draft]
  );

  return (
    <div className="pb-24">
      <PageTitle
        title="Requirements"
        subtitle={
          <>
            Project • <span className="text-zinc-900 font-medium">{projectName}</span>
          </>
        }
        rightSlot={
          <div className="flex items-center gap-2">
            <button
              onClick={() => {
                setAddOpen(true);
                setAddError("");
                setAddText("");
                setDraft((p) => ({ ...p, ["__NEW__"]: "" }));
              }}
              className={cx(
                "inline-flex items-center gap-2 rounded-xl px-3 py-2",
                "bg-zinc-900 text-white hover:bg-zinc-800 transition-colors",
                "text-[12px] font-medium tracking-tight"
              )}
              title="Add a new requirement (must be complete to be added)"
            >
              <PlusCircle size={16} strokeWidth={2} />
              Add
            </button>

            <Pill tone={requirementsUnlocked ? "good" : "bad"}>
              <span className="inline-flex items-center gap-1.5">
                {requirementsUnlocked ? (
                  <CheckCircle2 size={12} strokeWidth={2} />
                ) : (
                  <AlertTriangle size={12} strokeWidth={2} />
                )}
                {stats.frozen}/{stats.total} frozen
              </span>
            </Pill>

            <Pill tone={stats.flagged ? "bad" : "good"}>
              <span className="inline-flex items-center gap-1.5">
                <AlertTriangle size={12} strokeWidth={2} />
                {stats.flagged} flagged
              </span>
            </Pill>

            <div className="ml-2 flex items-center gap-1.5">
              {[
                ["all", "All"],
                ["unfrozen", "Unfrozen"],
                ["frozen", "Frozen"]
              ].map(([m, label]) => (
                <SmallBtn
                  key={m}
                  active={showMode === m}
                  onClick={() => setShowMode(m)}
                  title={label}
                >
                  {label}
                </SmallBtn>
              ))}
            </div>

            <div className="ml-2 flex items-center gap-1.5">
              <SmallBtn
                active={viewMode === "cards"}
                onClick={() => setViewMode("cards")}
                title="Card view"
              >
                <LayoutGrid size={14} strokeWidth={1.9} />
                Cards
              </SmallBtn>

              <SmallBtn
                active={viewMode === "list"}
                onClick={() => {
                  setViewMode("list");

                  // ✅ Unlock sheets (Page.js state)
                  onListViewUnlock?.();

                  // ✅ (optional) keep context unlock if you still use it elsewhere
                  unlockFromRequirementsListView?.();
                }}
                title="List view"
              >
                <List size={14} strokeWidth={1.9} />
                List
              </SmallBtn>

              <div className="w-px h-6 bg-zinc-200/80 mx-1" />

              <SmallBtn
                onClick={smaller}
                disabled={viewMode !== "cards"}
                title={
                  viewMode === "cards"
                    ? "Smaller cards (click twice to reach 5×)"
                    : "Card sizing disabled in list view"
                }
              >
                <Minus size={14} strokeWidth={2} />
              </SmallBtn>

              <SmallBtn
                onClick={bigger}
                disabled={viewMode !== "cards"}
                title={viewMode === "cards" ? "Larger cards" : "Card sizing disabled in list view"}
              >
                <Plus size={14} strokeWidth={2} />
              </SmallBtn>
            </div>
          </div>
        }
      />

      {/* Category cards only */}
      <div className="max-w-6xl mx-auto px-10 space-y-5">
        {buckets.order.map((domainKey) => {
          const list = filtered[domainKey] || [];
          if (!list.length) return null;

          const full = buckets.map[domainKey] || [];
          const unfrozenCount = full.filter((r) => !frozen(r)).length;
          const flaggedCount = full.filter((r) => r.flagged).length;

          const Icon = ICONS[domainKey] || Wrench;

          return (
            <div
              key={domainKey}
              className={cx("rounded-xl border border-zinc-200/80 bg-white", SH_SURFACE)}
            >
              <div className="px-4 py-3 border-b border-zinc-200/70 bg-[#fbfbfa] flex items-center justify-between">
                <div className="min-w-0 flex items-center gap-2">
                  <div className="h-8 w-8 rounded-xl border border-zinc-200/80 bg-white grid place-items-center">
                    <Icon size={16} strokeWidth={1.8} className="text-zinc-800" />
                  </div>
                  <div className="min-w-0">
                    <div className="text-[12px] font-semibold tracking-tight text-zinc-900">
                      {domainKey}
                    </div>
                    <div className="text-[11px] text-zinc-500 tracking-tight">
                      {unfrozenCount} unfrozen • {flaggedCount} flagged • {full.length} total
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <Pill tone={unfrozenCount ? "bad" : "good"}>{unfrozenCount} unfrozen</Pill>
                  <Pill tone={flaggedCount ? "bad" : "good"}>{flaggedCount} flagged</Pill>
                </div>
              </div>

              {/* CARDS */}
              {viewMode === "cards" ? (
                <div className={cx("p-4", gridClass)}>
                  {list.map((r) => {
                    const filesCount = Array.isArray(r.files) ? r.files.length : 0;

                    return (
                      <button
                        key={r.id}
                        onClick={() => setModalId(r.id)}
                        className={cx(
                          "text-left rounded-2xl border border-zinc-200/80 bg-white hover:bg-[#fbfbfa] transition-colors",
                          SH_TILE
                        )}
                      >
                        <div className={cardPad}>
                          <div className="flex items-start justify-between gap-3">
                            <div className="min-w-0">
                              <div className="flex items-center gap-2">
                                <div className="text-[11px] text-zinc-500 tracking-tight">
                                  {r.id}
                                </div>
                                <StatusIcon r={r} />
                              </div>

                              <div className="mt-1 text-[13px] font-semibold tracking-tight text-zinc-900 line-clamp-2">
                                {r.text}
                              </div>
                            </div>

                            <ChevronRight
                              size={16}
                              strokeWidth={1.8}
                              className="text-zinc-400 mt-1"
                            />
                          </div>

                          <div className="mt-3 flex flex-wrap gap-2">
                            {r.reqType ? <ReqTypePill reqType={r.reqType} /> : null}

                            {frozen(r) ? (
                              <Pill tone="good">Frozen</Pill>
                            ) : r.flagged ? (
                              <Pill tone="bad">Flagged</Pill>
                            ) : (
                              <Pill>Incomplete</Pill>
                            )}

                            <Pill>{r.priority}</Pill>
                          </div>

                          <div className="mt-3 flex items-center justify-between">
                            <div className="text-[11px] text-zinc-500">
                              {r.ownerRole} • {r.ownerName}
                            </div>

                            <div className="text-[11px] text-zinc-600 inline-flex items-center gap-2">
                              <Paperclip
                                size={14}
                                strokeWidth={1.7}
                                className="text-zinc-500"
                              />
                              {filesCount}
                            </div>
                          </div>

                          {r.flagged && r.aiAdvice ? (
                            <div className="mt-3 text-[11px] text-zinc-500 tracking-tight line-clamp-2">
                              AI: <span className="text-zinc-700">{r.aiAdvice}</span>
                            </div>
                          ) : null}
                        </div>
                      </button>
                    );
                  })}
                </div>
              ) : (
                /* LIST */
                <div className="overflow-hidden">
                  <div className="grid grid-cols-12 text-[11px] font-medium text-zinc-500 bg-[#fbfbfa] border-b border-zinc-200/70">
                    <div className="col-span-2 px-5 py-3">ID</div>
                    <div className="col-span-5 px-5 py-3">Requirement</div>
                    <div className="col-span-2 px-5 py-3">Owner</div>
                    <div className="col-span-2 px-5 py-3">Status</div>
                    <div className="col-span-1 px-5 py-3 text-right">Files</div>
                  </div>

                  {list.map((r) => {
                    const open = expandedId === r.id;
                    const filesCount = Array.isArray(r.files) ? r.files.length : 0;

                    return (
                      <div key={r.id} className="border-b last:border-b-0 border-zinc-200/60">
                        <button
                          onClick={() => setExpandedId((p) => (p === r.id ? null : r.id))}
                          className="w-full text-left grid grid-cols-12 text-[13px] hover:bg-[#fbfbfa] transition-colors"
                        >
                          <div className="col-span-2 px-5 py-3 text-zinc-600">
                            <div className="flex items-center gap-2">
                              <span>{r.id}</span>
                              <StatusIcon r={r} />
                            </div>
                          </div>

                          <div className="col-span-5 px-5 py-3">
                            <div className="text-zinc-900 leading-snug">{r.text}</div>

                            <div className="mt-2 flex flex-wrap gap-2 items-center">
                              {r.reqType ? <ReqTypePill reqType={r.reqType} /> : null}

                              {frozen(r) ? (
                                <Pill tone="good">Frozen</Pill>
                              ) : r.flagged ? (
                                <Pill tone="bad">Flagged</Pill>
                              ) : (
                                <Pill>Incomplete</Pill>
                              )}

                              {r.lastUpdated ? <Pill>{r.lastUpdated}</Pill> : null}
                            </div>

                            {r.flagged && r.aiAdvice ? (
                              <div className="mt-2 text-[11px] text-zinc-500 tracking-tight">
                                AI advice: <span className="text-zinc-700">{r.aiAdvice}</span>
                              </div>
                            ) : null}
                          </div>

                          <div className="col-span-2 px-5 py-3 text-zinc-600">
                            <div className="text-zinc-900">{r.ownerRole}</div>
                            <div className="mt-0.5 text-[11px] text-zinc-500">
                              Added by {r.ownerName}
                            </div>
                          </div>

                          <div className="col-span-2 px-5 py-3 text-zinc-600">
                            <div className="text-zinc-900">{r.priority}</div>
                            <div className="mt-0.5 text-[11px] text-zinc-500">
                              {frozen(r) ? "Frozen" : r.flagged ? "Flagged" : "Incomplete"}
                            </div>
                          </div>

                          <div className="col-span-1 px-5 py-3 text-right text-zinc-600">
                            <span className="inline-flex items-center justify-end gap-2">
                              <Paperclip
                                size={14}
                                strokeWidth={1.7}
                                className="text-zinc-500"
                              />
                              {filesCount}
                            </span>
                          </div>
                        </button>

                        {open ? (
                          <div className="px-5 pb-5">
                            <div className="rounded-xl border border-zinc-200/80 bg-[#fbfbfa] p-4">
                              <Editor
                                r={r}
                                draft={draft}
                                setDraft={setDraft}
                                onSave={handleSave}
                                saving={saving}
                                running={running}
                              />
                            </div>
                          </div>
                        ) : null}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* ADD Modal */}
      <Modal
        open={addOpen}
        onClose={() => {
          setAddOpen(false);
          setAddText("");
          setAddError("");
        }}
      >
        <div className="px-5 py-4 flex items-start justify-between border-b border-zinc-200/70 bg-white">
          <div className="min-w-0">
            <div className="text-[11px] text-zinc-500 tracking-tight">New requirement</div>
            <div className="mt-1 text-[16px] font-semibold tracking-tight text-zinc-900">
              Add a complete, testable requirement
            </div>
            <div className="mt-2 flex flex-wrap gap-2">
              <Pill>Must be “Good” to add</Pill>
              <Pill tone="good">Frozen on add</Pill>
            </div>
          </div>

          <button
            onClick={() => {
              setAddOpen(false);
              setAddText("");
              setAddError("");
            }}
            className="h-9 w-9 rounded-xl grid place-items-center hover:bg-zinc-100 transition-colors"
            aria-label="Close"
          >
            <span className="sr-only">Close</span>
            <span className="text-zinc-700">✕</span>
          </button>
        </div>

        <div className="p-5 bg-[#fbfbfa]">
          <Surface className="p-4" shadow={SH_TILE}>
            <Editor
              r={addTemp}
              draft={draft}
              setDraft={setDraft}
              onSave={handleAddSave}
              saving={saving}
              running={running}
              addMode
              addText={addText}
              setAddText={setAddText}
              addError={addError}
            />
          </Surface>
        </div>
      </Modal>

      {/* EDIT Modal */}
      <Modal open={!!modalReq} onClose={() => setModalId(null)}>
        {modalReq ? (
          <>
            <div className="px-5 py-4 flex items-start justify-between border-b border-zinc-200/70 bg-white">
              <div className="min-w-0">
                <div className="text-[11px] text-zinc-500 tracking-tight">
                  {modalReq.id} • {modalReq.reqType}
                </div>
                <div className="mt-1 text-[16px] font-semibold tracking-tight text-zinc-900">
                  {modalReq.text}
                </div>

                <div className="mt-2 flex flex-wrap gap-2">
                  <Pill>{modalReq.priority}</Pill>
                  {modalReq.reqType ? <ReqTypePill reqType={modalReq.reqType} /> : null}
                  {frozen(modalReq) ? (
                    <Pill tone="good">Frozen</Pill>
                  ) : modalReq.flagged ? (
                    <Pill tone="bad">Flagged</Pill>
                  ) : (
                    <Pill>Incomplete</Pill>
                  )}
                </div>
              </div>

              <div className="flex items-center gap-1">
                <button
                  onClick={() => {
                    const ok = window.confirm(`Delete ${modalReq.id}? This cannot be undone.`);
                    if (!ok) return;
                    removeRequirement(modalReq.id);
                    setModalId(null);
                  }}
                  className="h-9 px-3 rounded-xl inline-flex items-center gap-2 hover:bg-amber-50 text-amber-900 transition-colors"
                  title="Delete requirement"
                >
                  <Trash2 size={16} strokeWidth={2} />
                  <span className="text-[12px] font-medium tracking-tight">Delete</span>
                </button>

                <button
                  onClick={() => setModalId(null)}
                  className="h-9 w-9 rounded-xl grid place-items-center hover:bg-zinc-100 transition-colors"
                  aria-label="Close"
                >
                  <span className="sr-only">Close</span>
                  <span className="text-zinc-700">✕</span>
                </button>
              </div>
            </div>

            <div className="p-5 bg-[#fbfbfa]">
              <Surface className="p-4" shadow={SH_TILE}>
                <Editor
                  r={modalReq}
                  draft={draft}
                  setDraft={setDraft}
                  onSave={handleSave}
                  saving={saving}
                  running={running}
                />
              </Surface>
            </div>
          </>
        ) : null}
      </Modal>
    </div>
  );
}


==========================================================================================
FILE: components/RootCauseViewport.js
==========================================================================================
// components/RootCauseViewport.js
"use client";

const cx = (...c) => c.filter(Boolean).join(" ");

/* ----------------------------- Shadows (different recipes) ----------------------------- */
const SH_SURFACE =
  "shadow-[0_1px_0_rgba(0,0,0,0.05),0_14px_40px_rgba(0,0,0,0.06)]";
const SH_TILE =
  "shadow-[0_1px_0_rgba(0,0,0,0.05),0_10px_24px_rgba(0,0,0,0.06)]";

function PageTitle({ title, subtitle }) {
  return (
    <div className="max-w-5xl mx-auto px-10 pt-14 pb-6">
      <div className="text-[40px] leading-[1.12] font-semibold tracking-tight">
        {title}
      </div>
      {subtitle ? (
        <div className="mt-2 text-[13px] text-zinc-600 tracking-tight">{subtitle}</div>
      ) : null}
    </div>
  );
}

function Surface({ className = "", children, shadow = SH_SURFACE }) {
  return (
    <div
      className={cx(
        "rounded-xl border border-zinc-200/80 bg-white",
        shadow,
        className
      )}
    >
      {children}
    </div>
  );
}

export default function RootCauseViewport({ data }) {
  const { focusItem, categories, fiveWhys } = data.content;

  return (
    <div className="pb-24">
      <PageTitle title="Root Cause Analysis" />

      <div className="max-w-6xl mx-auto px-10">
        <Surface className="p-6">
          <div className="text-[13px] font-medium tracking-tight text-zinc-900">
            Focus item
          </div>

          <div className="mt-4 grid grid-cols-12 gap-4 text-[13px] tracking-tight">
            <div className="col-span-6">
              <div className="text-[11px] text-zinc-500">Failure mode</div>
              <div className="mt-1 text-zinc-900">{focusItem.failureMode}</div>
            </div>
            <div className="col-span-6">
              <div className="text-[11px] text-zinc-500">Effect</div>
              <div className="mt-1 text-zinc-900">{focusItem.effect}</div>
            </div>

            <div className="col-span-12">
              <div className="text-[11px] text-zinc-500">Current controls</div>
              <div className="mt-2 flex flex-wrap gap-2">
                {focusItem.currentControls.map((c, idx) => (
                  <span
                    key={idx}
                    className="text-[11px] px-2 py-1 rounded-full border border-zinc-200/80 bg-[#fbfbfa] text-zinc-700"
                  >
                    {c}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </Surface>

        <div className="mt-6 grid grid-cols-12 gap-6">
          <div className="col-span-7">
            <div className="text-[13px] font-medium tracking-tight">
              Fishbone categories
            </div>
            <div className="mt-3 space-y-3">
              {categories.map((cat) => (
                <Surface key={cat.name} shadow={SH_TILE} className="overflow-hidden">
                  <div className="px-5 py-4 flex items-center justify-between border-b border-zinc-200/70 bg-[#fbfbfa]">
                    <div className="text-[13px] font-medium tracking-tight">
                      {cat.name}
                    </div>
                    <div className="text-[11px] text-zinc-500">
                      {cat.items.length} items
                    </div>
                  </div>
                  <div className="px-5 py-4 space-y-2">
                    {cat.items.map((it, idx) => (
                      <div key={idx} className="text-[13px] text-zinc-800 flex gap-2">
                        <span className="text-zinc-300">•</span>
                        <span>{it}</span>
                      </div>
                    ))}
                  </div>
                </Surface>
              ))}
            </div>
          </div>

          <div className="col-span-5">
            <div className="text-[13px] font-medium tracking-tight">5 Whys</div>
            <Surface className="mt-3 overflow-hidden" shadow={SH_TILE}>
              {fiveWhys.map((w, idx) => (
                <div
                  key={idx}
                  className={cx(
                    "px-5 py-4",
                    idx !== 0 && "border-t border-zinc-200/70"
                  )}
                >
                  <div className="text-[11px] text-zinc-500">Why {w.why}</div>
                  <div className="mt-1 text-[13px] text-zinc-800">{w.text}</div>
                </div>
              ))}
            </Surface>
          </div>
        </div>
      </div>
    </div>
  );
}


==========================================================================================
FILE: components/Sidebar.js
==========================================================================================
// components/Sidebar.js
"use client";

import { useMemo, useState } from "react";
import {
  Home,
  CalendarDays,
  Sparkles,
  Inbox,
  Settings,
  Trash2,
  Search,
  ChevronDown,
  GitBranch,
  Plus
} from "lucide-react";

import { useDFMEA } from "@/contexts/Context";

const cx = (...c) => c.filter(Boolean).join(" ");

function NavItem({ icon: Icon, label, active, onClick, right }) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={cx(
        "w-full px-2 py-1.5 rounded-md cursor-default flex items-center gap-2",
        "text-[13px] tracking-tight text-left",
        "hover:bg-zinc-200/40 transition-colors",
        active ? "bg-zinc-200/50 text-zinc-900" : "text-zinc-700"
      )}
    >
      <Icon size={16} strokeWidth={1.7} className="text-zinc-700" />
      <span className="truncate font-medium flex-1">{label}</span>
      {right}
    </button>
  );
}

/**
 * ✅ SubItem must NOT be a <button> if it contains another <button>.
 * Otherwise you get: <button> cannot be a descendant of <button>.
 *
 * So this is a div with role="button" (keyboard accessible).
 */
function SubItem({ label, onClick, active, right }) {
  return (
    <div
      role="button"
      tabIndex={0}
      onClick={onClick}
      onKeyDown={(e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          onClick?.();
        }
      }}
      className={cx(
        "group w-full px-2 py-1.5 rounded-md text-left",
        "text-[12px] tracking-tight",
        "hover:bg-zinc-200/40 transition-colors",
        "flex items-center gap-2 select-none cursor-pointer",
        active ? "text-zinc-900 bg-zinc-200/40" : "text-zinc-700"
      )}
    >
      <span className="truncate flex-1">{label}</span>
      {right}
    </div>
  );
}

export default function Sidebar({ tasksTitle, tasks = [] }) {
  const {
    activeTab,
    setActiveTab,
    workflows,
    selectedWorkflowId,
    setSelectedWorkflowId,
    createWorkflow,
    deleteWorkflow
  } = useDFMEA();

  // ✅ collapsed by default
  const [workflowsOpen, setWorkflowsOpen] = useState(false);

  const rightChevron = useMemo(
    () => (
      <ChevronDown
        size={16}
        strokeWidth={1.8}
        className={cx(
          "text-zinc-500 transition-transform",
          workflowsOpen ? "rotate-0" : "-rotate-90"
        )}
      />
    ),
    [workflowsOpen]
  );

  return (
    <aside className="w-[280px] h-full bg-[#f5f5f3] border-r border-zinc-200/70">
      <div className="h-full flex flex-col px-3 py-3">
        {/* header */}
        <div className="flex items-center gap-3 px-2 py-2 rounded-md hover:bg-zinc-200/40 transition-colors">
          <div className="h-8 w-8 rounded-xl bg-white border border-zinc-200/80 flex items-center justify-center text-xs font-semibold text-zinc-800">
            IA
          </div>
          <div className="min-w-0 leading-tight">
            <div className="text-[13px] font-semibold tracking-tight text-zinc-900 truncate">
              Engineering Space
            </div>
            <div className="text-[11px] text-zinc-500 truncate">Workspace • mock</div>
          </div>
        </div>

        {/* search */}
        <div className="mt-2 px-2">
          <div className="rounded-md bg-white border border-zinc-200/80 px-2.5 py-2 flex items-center gap-2">
            <Search size={16} strokeWidth={1.7} className="text-zinc-600" />
            <input
              className="w-full text-[13px] tracking-tight outline-none placeholder:text-zinc-400 bg-transparent"
              placeholder="Search"
              disabled
            />
          </div>
        </div>

        {/* nav */}
        <div className="mt-3 px-2 space-y-0.5">
          <NavItem
            icon={Home}
            label="Home"
            active={activeTab === "home"}
            onClick={() => setActiveTab("home")}
          />
          <NavItem
            icon={CalendarDays}
            label="Meetings"
            active={activeTab === "meetings"}
            onClick={() => setActiveTab("meetings")}
          />
          <NavItem
            icon={Sparkles}
            label="Notion AI"
            active={activeTab === "ai"}
            onClick={() => setActiveTab("ai")}
          />
          <NavItem
            icon={Inbox}
            label="Inbox"
            active={activeTab === "inbox"}
            onClick={() => setActiveTab("inbox")}
          />

          {/* ✅ Workflows: expand/collapse menu */}
          <NavItem
            icon={GitBranch}
            label="Workflows"
            active={workflowsOpen}
            right={rightChevron}
            onClick={() => setWorkflowsOpen((v) => !v)}
          />

          {workflowsOpen ? (
            <div className="pl-6 mt-0.5 space-y-0.5">
              {workflows.length ? (
                workflows.map((w) => (
                  <SubItem
                    key={w.id}
                    label={w.title?.trim() ? w.title : "Untitled workflow"}
                    active={selectedWorkflowId === w.id && activeTab === "workflows"}
                    onClick={() => {
                      setActiveTab("workflows");
                      setSelectedWorkflowId(w.id);
                    }}
                    right={
                      <button
                        type="button"
                        title="Delete workflow"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();

                          const ok = window.confirm(
                            `Delete workflow "${
                              w.title?.trim() ? w.title : "Untitled workflow"
                            }"?`
                          );
                          if (!ok) return;

                          deleteWorkflow?.(w.id);
                        }}
                        className={cx(
                          "opacity-0 group-hover:opacity-100 transition",
                          "h-7 w-7 rounded-md grid place-items-center",
                          "hover:bg-amber-50 text-amber-900"
                        )}
                      >
                        <Trash2 size={14} strokeWidth={2} />
                      </button>
                    }
                  />
                ))
              ) : (
                <div className="px-2 py-2 text-[12px] text-zinc-500">
                  No workflows yet.
                </div>
              )}

              <button
                type="button"
                onClick={() => createWorkflow()}
                className="mt-1 w-full px-2 py-1.5 rounded-md text-left text-[12px] tracking-tight
                           hover:bg-zinc-200/40 transition-colors flex items-center gap-2 text-zinc-700"
              >
                <Plus size={14} strokeWidth={1.8} className="text-zinc-600" />
                Add new workflow
              </button>
            </div>
          ) : null}
        </div>

        {/* tasks */}
        <div className="mt-5 px-2">
          <div className="text-[11px] font-medium text-zinc-500 tracking-tight">
            {tasksTitle || "Tasks"}
          </div>

          <div className="mt-2 space-y-1">
            {tasks.map((t) => (
              <div
                key={t.id}
                className={cx(
                  "px-2 py-1.5 rounded-md",
                  "hover:bg-zinc-200/40 transition-colors",
                  "flex items-center gap-2"
                )}
              >
                <div
                  className={cx(
                    "text-[13px] tracking-tight",
                    t.done ? "text-zinc-400 line-through" : "text-zinc-800"
                  )}
                >
                  {t.label}
                </div>
              </div>
            ))}

            {!tasks.length ? (
              <div className="text-[12px] text-zinc-500 px-2 py-2">
                No tasks in this tab.
              </div>
            ) : null}
          </div>
        </div>

        {/* footer */}
        <div className="mt-auto px-2 pt-4 space-y-0.5">
          <NavItem icon={Settings} label="Settings" onClick={() => {}} />
          <NavItem icon={Trash2} label="Trash" onClick={() => {}} />
        </div>
      </div>
    </aside>
  );
}


==========================================================================================
FILE: components/TopNav.js
==========================================================================================
// components/TopNav.js
"use client";

import { useLayoutEffect, useMemo, useRef, useState } from "react";
import { Search, Bell, CheckCircle2, Loader2, X } from "lucide-react";
import { useDFMEA } from "../contexts/Context";

const cx = (...c) => c.filter(Boolean).join(" ");

function Pill({ tone = "neutral", children }) {
  const cls =
    tone === "good"
      ? "bg-emerald-50 border-emerald-200/70 text-emerald-900"
      : tone === "busy"
      ? "bg-[#fbfbfa] border-zinc-200/80 text-zinc-700"
      : "bg-[#fbfbfa] border-zinc-200/80 text-zinc-700";

  return (
    <span className={cx("text-[11px] px-2 py-1 rounded-full border tracking-tight", cls)}>
      {children}
    </span>
  );
}

/** Small skeleton helper */
function SkeletonLine({ w = "w-full" }) {
  return <div className={cx("h-3 rounded-md bg-zinc-200/80", w)} />;
}

/** ✅ AI Analysis block (only this becomes skeleton when busy) */
function AiAnalysisBlock({ busy }) {
  return (
    <div className="mt-3 rounded-xl border border-zinc-200/80 bg-white p-3">
      <div className="text-[11px] text-zinc-500">AI analysis</div>

      {busy ? (
        <div className="mt-2 space-y-2 animate-pulse">
          <SkeletonLine w="w-[92%]" />
          <SkeletonLine w="w-[78%]" />
          <SkeletonLine w="w-[64%]" />
        </div>
      ) : (
        <div className="mt-2 text-[12px] text-zinc-700 leading-snug">
          Risk analysis complete. No critical downstream effects detected.
        </div>
      )}
    </div>
  );
}

export default function TopNav({ tabs, activeTab, onChangeTab, unlockSheets = false }) {
  const containerRef = useRef(null);
  const tabRefs = useRef({});
  const [indicator, setIndicator] = useState({ x: 0, w: 0, ready: false });

  const {
    activeNotice,
    noticeHistory,
    noticeAnalyzing,
    unreadCount,
    markAllRead,
    dismissActiveNotice
  } = useDFMEA();

  const [toastOpen, setToastOpen] = useState(false);

  const activeLabel = useMemo(
    () => tabs.find((t) => t.id === activeTab)?.label ?? "",
    [tabs, activeTab]
  );

  const measure = () => {
    const wrap = containerRef.current;
    const el = tabRefs.current[activeTab];
    if (!wrap || !el) return;

    const x = el.offsetLeft;
    const w = el.offsetWidth;

    setIndicator((prev) => {
      if (prev.ready && prev.x === x && prev.w === w) return prev;
      return { x, w, ready: true };
    });
  };

  useLayoutEffect(() => {
    measure();

    const wrap = containerRef.current;
    if (!wrap) return;

    const ro = new ResizeObserver(() => measure());
    ro.observe(wrap);

    const activeEl = tabRefs.current[activeTab];
    if (activeEl) ro.observe(activeEl);

    return () => ro.disconnect();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activeTab, tabs.length]);

  const activeBusy = activeNotice ? !!noticeAnalyzing?.[activeNotice.noticeId] : false;

  return (
    <div className="h-14 px-5 flex items-center justify-between bg-[#fbfbfa] border-b border-zinc-200/70">
      {/* Left: brand + tabs */}
      <div className="grid grid-cols-[280px_1fr] items-center gap-4 min-w-0">
        <div className="flex items-center gap-3 w-[280px] min-w-[280px]">
          <div className="h-8 w-8 rounded-xl bg-zinc-900 text-white flex items-center justify-center text-xs font-semibold">
            DF
          </div>

          <div className="min-w-0 leading-tight">
            <div className="text-[13px] font-semibold tracking-tight text-zinc-900 truncate">
              DFMEA Studio
            </div>
            <div className="text-[11px] text-zinc-500 truncate">
              Desktop mock • <span className="text-zinc-700">{activeLabel}</span>
            </div>
          </div>
        </div>

        <div className="flex items-center min-w-0">
          <div
            ref={containerRef}
            className={cx(
              "relative hidden lg:flex items-center gap-1",
              "bg-white rounded-xl p-1",
              "border border-zinc-200/80"
            )}
          >
            {/* sliding indicator */}
            <div
              aria-hidden="true"
              className={cx(
                "pointer-events-none absolute top-1 bottom-1 rounded-lg bg-zinc-900",
                "transition-[transform,width,opacity] duration-300 ease-out will-change-transform"
              )}
              style={{
                width: indicator.w,
                transform: `translate3d(${indicator.x}px,0,0)`,
                opacity: indicator.ready ? 1 : 0
              }}
            />

            {tabs.map((t) => {
              const isActive = t.id === activeTab;

              // ✅ only requirements is always accessible
              const isRequirementsTab = t.id === "requirements";

              // ✅ locked until unlockSheets becomes true
              const locked = !unlockSheets && !isRequirementsTab;

              return (
                <div
                  key={t.id}
                  ref={(node) => {
                    if (node) tabRefs.current[t.id] = node;
                  }}
                  className="relative group"
                >
                  <button
                    type="button"
                    disabled={locked}
                    aria-disabled={locked}
                    onClick={() => {
                      if (locked) return;
                      onChangeTab(t.id);
                    }}
                    className={cx(
                      "relative z-10 text-[13px] px-3 py-1.5 rounded-lg",
                      "font-medium tracking-tight transition-colors duration-200",
                      isActive ? "text-white" : "text-zinc-700",
                      !locked && !isActive ? "hover:text-zinc-900" : "",
                      locked ? "opacity-45 cursor-not-allowed" : "cursor-pointer"
                    )}
                  >
                    {t.label}
                  </button>

                  {/* Tooltip when locked */}
                  {locked ? (
                    <div
                      className={cx(
                        "pointer-events-none absolute left-1/2 -translate-x-1/2 top-full mt-2 z-[60]",
                        "w-[270px] rounded-xl border border-zinc-200/80 bg-white px-3 py-2",
                        "text-[11px] leading-snug text-zinc-700",
                        "shadow-[0_10px_30px_rgba(0,0,0,0.12)]",
                        "opacity-0 translate-y-1 scale-[0.98]",
                        "group-hover:opacity-100 group-hover:translate-y-0 group-hover:scale-100",
                        "transition-none"
                      )}
                    >
                      <div className="font-semibold text-zinc-900">Locked</div>

                      <div className="mt-1 text-zinc-600">
                        Finish{" "}
                        <span className="font-medium text-zinc-800">Requirements</span> first to
                        unlock this sheet.
                      </div>

                      <div className="mt-1 text-zinc-600">
                        <span className="font-medium text-zinc-800">Dev option:</span> click{" "}
                        <span className="font-medium text-zinc-800">“List view”</span> inside{" "}
                        <span className="font-medium text-zinc-800">Requirements</span> to unlock
                        early.
                      </div>

                      <div className="absolute -top-1 left-1/2 -translate-x-1/2 h-2 w-2 rotate-45 bg-white border-l border-t border-zinc-200/80" />
                    </div>
                  ) : null}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Right */}
      <div className="flex items-center gap-3 relative">
        <div className="hidden xl:flex items-center gap-2 bg-white rounded-xl px-3 py-2 border border-zinc-200/80">
          <Search size={18} strokeWidth={1.6} className="text-zinc-600" />
          <input
            className="w-64 text-[13px] outline-none placeholder:text-zinc-400 bg-transparent"
            placeholder="Search (mock)"
            disabled
          />
        </div>

        {/* 🔔 Change notice */}
        <div className="relative">
          <button
            onClick={() => {
              setToastOpen((v) => !v);
              markAllRead();
            }}
            className={cx(
              "h-10 w-10 rounded-xl bg-white border border-zinc-200/80",
              "grid place-items-center hover:bg-zinc-100 transition-colors"
            )}
            title="Change notices"
            aria-label="Change notices"
          >
            <Bell size={18} strokeWidth={1.6} className="text-zinc-700" />

            {unreadCount ? (
              <span className="absolute -top-1 -right-1 h-5 min-w-[20px] px-1 rounded-full bg-zinc-900 text-white text-[10px] grid place-items-center">
                {unreadCount}
              </span>
            ) : null}
          </button>

          {/* Active notice card */}
          {activeNotice && !toastOpen ? (
            <div
              className={cx(
                "absolute right-0 mt-2 w-[380px] z-50",
                "rounded-2xl border border-zinc-200/80 bg-white overflow-hidden",
                "shadow-[0_1px_0_rgba(0,0,0,0.05),0_20px_50px_rgba(0,0,0,0.12)]"
              )}
            >
              <div className="px-4 py-3 flex items-start gap-3">
                <div className="mt-0.5 h-8 w-8 rounded-xl bg-white border border-zinc-200/80 grid place-items-center">
                  <Bell size={16} strokeWidth={1.8} className="text-zinc-700" />
                </div>

                <div className="min-w-0 flex-1">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                        Change notice • {activeNotice.reqId}
                      </div>

                      <div className="mt-0.5 text-[11px] text-zinc-500 tracking-tight line-clamp-2">
                        {activeNotice.summary}
                      </div>
                    </div>

                    <button
                      onClick={dismissActiveNotice}
                      className="h-8 w-8 rounded-xl grid place-items-center hover:bg-zinc-100 transition-colors"
                      aria-label="Close"
                      title="Close"
                    >
                      <X size={16} strokeWidth={1.8} className="text-zinc-600" />
                    </button>
                  </div>

                  <div className="mt-2 flex items-center gap-2">
                    <Pill>{activeNotice.requestedBy}</Pill>
                    <Pill>{activeNotice.timestamp}</Pill>

                    {activeBusy ? (
                      <Pill tone="busy">
                        <span className="inline-flex items-center gap-1.5">
                          <Loader2 size={12} strokeWidth={2} className="animate-spin" />
                          AI analyzing…
                        </span>
                      </Pill>
                    ) : (
                      <Pill tone="good">
                        <span className="inline-flex items-center gap-1.5">
                          <CheckCircle2 size={12} strokeWidth={2} />
                          Done
                        </span>
                      </Pill>
                    )}
                  </div>

                  <div className="mt-3 rounded-xl border border-zinc-200/80 bg-[#fbfbfa] p-3">
                    <div className="text-[11px] text-zinc-500">Impact</div>
                    <div className="mt-1 text-[13px] text-zinc-800">{activeNotice.impact}</div>
                  </div>

                  <AiAnalysisBlock busy={activeBusy} />
                </div>
              </div>
            </div>
          ) : null}

          {/* Dropdown history (unchanged) */}
          {toastOpen ? (
            <div
              className={cx(
                "absolute right-0 mt-2 w-[360px] z-50",
                "rounded-2xl border border-zinc-200/80 bg-white overflow-hidden",
                "shadow-[0_1px_0_rgba(0,0,0,0.05),0_20px_50px_rgba(0,0,0,0.12)]"
              )}
            >
              <div className="px-4 py-3 border-b border-zinc-200/70 bg-[#fbfbfa] flex items-center justify-between">
                <div>
                  <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                    Change notices
                  </div>
                  <div className="text-[11px] text-zinc-500 tracking-tight">
                    Auto risk analysis runs in background (mock)
                  </div>
                </div>

                <button
                  onClick={() => setToastOpen(false)}
                  className="text-[11px] px-2 py-1 rounded-xl bg-white border border-zinc-200/80 text-zinc-700 hover:bg-zinc-100 transition-colors"
                >
                  Close
                </button>
              </div>

              <div className="max-h-[360px] overflow-y-auto">
                {!noticeHistory.length ? (
                  <div className="px-4 py-4 text-[12px] text-zinc-500">No notices yet.</div>
                ) : (
                  noticeHistory.map((n) => {
                    const busy = !!noticeAnalyzing[n.noticeId];
                    return (
                      <div
                        key={n.noticeId}
                        className="px-4 py-3 border-b last:border-b-0 border-zinc-200/60 hover:bg-[#fbfbfa] transition-colors"
                      >
                        <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
                          {n.reqId} • change notice
                        </div>

                        {busy ? (
                          <div className="mt-1.5 space-y-2 animate-pulse">
                            <SkeletonLine w="w-[92%]" />
                            <SkeletonLine w="w-[78%]" />
                          </div>
                        ) : (
                          <div className="mt-0.5 text-[11px] text-zinc-500 tracking-tight line-clamp-2">
                            {n.summary}
                          </div>
                        )}

                        <div className="mt-2 flex items-center gap-2">
                          <Pill>{n.requestedBy}</Pill>
                          <Pill>{n.timestamp}</Pill>
                          {busy ? (
                            <Pill tone="busy">
                              <span className="inline-flex items-center gap-1.5">
                                <Loader2 size={12} strokeWidth={2} className="animate-spin" />
                                AI analyzing…
                              </span>
                            </Pill>
                          ) : (
                            <Pill tone="good">
                              <span className="inline-flex items-center gap-1.5">
                                <CheckCircle2 size={12} strokeWidth={2} />
                                Done
                              </span>
                            </Pill>
                          )}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
            </div>
          ) : null}
        </div>

        <button className="text-[13px] font-medium tracking-tight px-3.5 py-2 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 transition-colors">
          Share
        </button>
      </div>
    </div>
  );
}


==========================================================================================
FILE: components/Workflows.js
==========================================================================================
// components/Workflows.js
"use client";

import {
  forwardRef,
  memo,
  useCallback,
  useEffect,
  useImperativeHandle,
  useMemo,
  useRef,
  useState
} from "react";
import { List, Workflow as WorkflowIcon, Save, Plus, Trash2 } from "lucide-react";
import { v4 as uuidv4 } from "uuid";

import {
  ReactFlow,
  ReactFlowProvider,
  Background,
  MarkerType,
  Position,
  Handle,
  EdgeLabelRenderer,
  useReactFlow
} from "@xyflow/react";

import { useDFMEA } from "@/contexts/Context";

// ✅ visual-only design system
import {
  WF_GRID,
  wfGetEdgeStroke,
  wfNodeShellClass,
  wfNodeLabelClass,
  wfNodeDeleteBtnClass,
  wfEdgeLabelPillClass,
  wfNodeConnectionIcons,
  wfNodeIconButtonClass,
  wfDecisionDiamond,
  wfConditionDiamond,
  wfHintOverlayClass,
  wfBackgroundGrid,

  // ✅ NEW: popover cosmetics moved here
  wfNodePopoverStyle,
  wfNodePopoverContainerClass,
  wfNodePopoverTitleClass,
  wfNodePopoverMetaTextClass,
  wfNodePopoverSectionLabelClass,
  wfNodePopoverInputClass,
  wfNodePopoverTextareaClass,
  wfNodePopoverHintClass,
  wfNodePopoverEmptyHintClass
} from "@/lib/workflowVisuals";

const cx = (...c) => c.filter(Boolean).join(" ");

/* ============================== TYPES / CONSTANTS ============================== */
const CONNECTION_TYPES = {
  SERIES: "series",
  DECISION: "decision",
  PARALLEL: "parallel",
  SUBSTEP: "substep",
  ROUTE: "route",
  CONDITION: "condition"
};

const GRID = WF_GRID;

const gridToPixel = (gridX, gridY) => ({
  x: gridX * GRID.CELL_WIDTH,
  y: gridY * GRID.CELL_HEIGHT
});

const pixelToGrid = (x, y) => ({
  gridX: Math.round((x ?? 0) / GRID.CELL_WIDTH),
  gridY: Math.round((y ?? 0) / GRID.CELL_HEIGHT)
});

function getHandlesForType(type) {
  switch (type) {
    case CONNECTION_TYPES.ROUTE:
      return { sourceHandle: "l", targetHandle: "r" };
    case CONNECTION_TYPES.SUBSTEP:
      return { sourceHandle: "b", targetHandle: "l" };
    case CONNECTION_TYPES.PARALLEL:
      return { sourceHandle: "b", targetHandle: "t" };
    default:
      return { sourceHandle: "r", targetHandle: "l" };
  }
}

/* ============================== NODE POPOVER (VIEW + EDIT) ============================== */
function NodePopover({
  pinned,
  title,
  subtitle,
  detail,
  onChangeTitle,
  onChangeSubtitle,
  onChangeDetail
}) {
  const hasExtra = Boolean((subtitle || "").trim() || (detail || "").trim());

  return (
    <div
      className={wfNodePopoverContainerClass({ pinned })}
      style={wfNodePopoverStyle}
    >
      <div className={wfNodePopoverTitleClass}>{title || "Step"}</div>

      {pinned ? (
        <div className="mt-2 grid gap-2">
          <div>
            <div className={wfNodePopoverSectionLabelClass}>Title</div>
            <input
              value={title || ""}
              onChange={(e) => onChangeTitle?.(e.target.value)}
              onClick={(e) => e.stopPropagation()}
              className={wfNodePopoverInputClass}
              placeholder="Step title..."
            />
          </div>

          <div>
            <div className={wfNodePopoverSectionLabelClass}>Subtitle</div>
            <input
              value={subtitle || ""}
              onChange={(e) => onChangeSubtitle?.(e.target.value)}
              onClick={(e) => e.stopPropagation()}
              className={wfNodePopoverInputClass}
              placeholder="Short subtitle..."
            />
          </div>

          <div>
            <div className={wfNodePopoverSectionLabelClass}>Description</div>
            <textarea
              value={detail || ""}
              onChange={(e) => onChangeDetail?.(e.target.value)}
              onClick={(e) => e.stopPropagation()}
              rows={4}
              className={wfNodePopoverTextareaClass}
              placeholder="Explain what this step does, output, notes..."
            />
          </div>

          <div className={wfNodePopoverHintClass}>Tip: click outside to close</div>
        </div>
      ) : (
        <>
          {subtitle?.trim() ? (
            <div className={wfNodePopoverMetaTextClass}>{subtitle}</div>
          ) : null}

          {detail?.trim() ? (
            <div className={wfNodePopoverMetaTextClass} style={{ whiteSpace: "pre-wrap" }}>
              {detail}
            </div>
          ) : null}

          {!hasExtra ? (
            <div className={wfNodePopoverEmptyHintClass}>Click node to add details</div>
          ) : null}
        </>
      )}
    </div>
  );
}

/* ============================== NODE ============================== */
function ProcessNode({ id, data, selected }) {
  const [isEditingInlineTitle, setIsEditingInlineTitle] = useState(false);
  const [titleValue, setTitleValue] = useState(data.label);

  const [hovered, setHovered] = useState(false);

  useEffect(() => setTitleValue(data.label), [data.label]);

  const commitInlineTitle = () => {
    setIsEditingInlineTitle(false);
    const next = titleValue.trim();
    if (next) data.onUpdateLabel?.(id, next);
    else setTitleValue(data.label);
  };

  const cancelInlineTitle = () => {
    setIsEditingInlineTitle(false);
    setTitleValue(data.label);
  };

  const pinned = Boolean(data.isPinned);
  const showPopover = hovered || pinned;

  return (
    <div
      className="group relative"
      style={{ width: GRID.NODE_WIDTH }}
      onMouseEnter={() => setHovered(true)}
      onMouseLeave={() => setHovered(false)}
    >
      {/* Hidden handles */}
      <Handle id="l" type="source" position={Position.Left} style={{ opacity: 0 }} />
      <Handle id="r" type="source" position={Position.Right} style={{ opacity: 0 }} />
      <Handle id="t" type="source" position={Position.Top} style={{ opacity: 0 }} />
      <Handle id="b" type="source" position={Position.Bottom} style={{ opacity: 0 }} />

      <Handle id="l" type="target" position={Position.Left} style={{ opacity: 0 }} />
      <Handle id="r" type="target" position={Position.Right} style={{ opacity: 0 }} />
      <Handle id="t" type="target" position={Position.Top} style={{ opacity: 0 }} />
      <Handle id="b" type="target" position={Position.Bottom} style={{ opacity: 0 }} />

      {/* ✅ Hover + pinned popover */}
      {showPopover ? (
        <NodePopover
          pinned={pinned}
          title={data.label}
          subtitle={data.subtitle}
          detail={data.detail}
          onChangeTitle={(v) => data.onUpdateLabel?.(id, v)}
          onChangeSubtitle={(v) => data.onUpdateSubtitle?.(id, v)}
          onChangeDetail={(v) => data.onUpdateDetail?.(id, v)}
        />
      ) : null}

      <div
        onDoubleClick={(e) => {
          e.stopPropagation();
          setIsEditingInlineTitle(true);
        }}
        className={wfNodeShellClass({ selected: selected || pinned })}
      >
        {isEditingInlineTitle ? (
          <input
            autoFocus
            value={titleValue}
            onChange={(e) => setTitleValue(e.target.value)}
            onBlur={commitInlineTitle}
            onKeyDown={(e) => {
              if (e.key === "Enter") commitInlineTitle();
              if (e.key === "Escape") cancelInlineTitle();
            }}
            className="w-full bg-transparent text-center outline-none"
            onClick={(e) => e.stopPropagation()}
          />
        ) : (
          <span className={wfNodeLabelClass}>{data.label}</span>
        )}

        {!data.isStart && (
          <button
            title="Delete node"
            onClick={(e) => {
              e.stopPropagation();
              data.onDeleteNode(id);
            }}
            className={wfNodeDeleteBtnClass}
          >
            ×
          </button>
        )}

        {wfNodeConnectionIcons.map((ic) => {
          const stroke = wfGetEdgeStroke(ic.type);

          return (
            <button
              key={ic.type}
              title={ic.label}
              className={cx(wfNodeIconButtonClass(), ic.className)}
              style={{
                borderColor: stroke,
                boxShadow: `0 0 0 1px ${stroke}33`
              }}
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                data.onAddConnection(id, ic.type);
              }}
            >
              <span style={{ color: stroke }}>{ic.symbol}</span>
            </button>
          );
        })}
      </div>
    </div>
  );
}

/* ============================== EDGES ============================== */
function SeriesEdge({ id, sourceX, sourceY, targetX, targetY, markerEnd }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.SERIES);
  return (
    <path
      id={id}
      d={`M ${sourceX} ${sourceY} L ${targetX} ${targetY}`}
      stroke={stroke}
      strokeWidth="2"
      fill="none"
      markerEnd={markerEnd}
    />
  );
}

function RouteEdge({ sourceX, sourceY, targetX, targetY, markerEnd }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.ROUTE);
  const bendX = sourceX - 35;
  const d = `M ${sourceX} ${sourceY} L ${bendX} ${sourceY} L ${bendX} ${targetY} L ${targetX} ${targetY}`;
  return <path d={d} stroke={stroke} strokeWidth="2" fill="none" markerEnd={markerEnd} />;
}

function SubStepEdge({ sourceX, sourceY, targetX, targetY, markerEnd }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.SUBSTEP);
  const d = `M ${sourceX} ${sourceY} L ${sourceX} ${targetY} L ${targetX} ${targetY}`;
  return (
    <path
      d={d}
      stroke={stroke}
      strokeWidth="2"
      strokeDasharray="6,4"
      fill="none"
      markerEnd={markerEnd}
    />
  );
}

function ParallelEdge({ sourceX, sourceY, targetY }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.PARALLEL);
  const offset = 6;
  return (
    <>
      <path
        d={`M ${sourceX - offset} ${sourceY} L ${sourceX - offset} ${targetY}`}
        stroke={stroke}
        strokeWidth="2"
        fill="none"
      />
      <path
        d={`M ${sourceX + offset} ${sourceY} L ${sourceX + offset} ${targetY}`}
        stroke={stroke}
        strokeWidth="2"
        fill="none"
      />
    </>
  );
}

function DecisionEdge({ id, sourceX, sourceY, targetX, targetY, data, markerEnd }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.DECISION);
  const diamondX = sourceX + 35;
  const diamondY = sourceY;
  const diamondSize = 16;
  const bendX = diamondX + diamondSize + 25;

  const toDiamond = `M ${sourceX} ${sourceY} L ${diamondX - diamondSize} ${diamondY}`;
  const fromDiamond = `M ${diamondX + diamondSize} ${diamondY} L ${bendX} ${diamondY} L ${bendX} ${targetY} L ${targetX} ${targetY}`;

  return (
    <>
      <path d={toDiamond} stroke={stroke} strokeWidth="2" fill="none" />
      {data?.showDiamond && (
        <polygon
          points={`${diamondX},${diamondY - diamondSize} ${diamondX + diamondSize},${diamondY} ${diamondX},${diamondY + diamondSize} ${diamondX - diamondSize},${diamondY}`}
          fill={stroke}
          stroke={wfDecisionDiamond.stroke}
          strokeWidth={wfDecisionDiamond.strokeWidth}
        />
      )}
      <path d={fromDiamond} stroke={stroke} strokeWidth="2" fill="none" markerEnd={markerEnd} />

      {data?.label ? (
        <EdgeLabelRenderer>
          <div
            style={{
              position: "absolute",
              transform: `translate(-50%, -50%) translate(${bendX + 46}px, ${targetY - 12}px)`,
              pointerEvents: "all"
            }}
            className="cursor-pointer select-none"
            onClick={(e) => {
              e.stopPropagation();
              data.setEditingEdgeId(id);
            }}
          >
            <div className={wfEdgeLabelPillClass()} style={{ color: stroke }}>
              {data.label}
            </div>
          </div>
        </EdgeLabelRenderer>
      ) : null}
    </>
  );
}

function ConditionEdge({ sourceX, sourceY, targetX, targetY, markerEnd }) {
  const stroke = wfGetEdgeStroke(CONNECTION_TYPES.CONDITION);

  const diamondX = sourceX + 35;
  const diamondY = sourceY;
  const diamondSize = 14;
  const bendX = diamondX + diamondSize + 20;

  const toDiamond = `M ${sourceX} ${sourceY} L ${diamondX - diamondSize} ${diamondY}`;
  const fromDiamond = `M ${diamondX + diamondSize} ${diamondY} L ${bendX} ${diamondY} L ${bendX} ${targetY} L ${targetX} ${targetY}`;

  return (
    <>
      <path d={toDiamond} stroke={stroke} strokeWidth="2" fill="none" />
      <polygon
        points={`${diamondX},${diamondY - diamondSize} ${diamondX + diamondSize},${diamondY} ${diamondX},${diamondY + diamondSize} ${diamondX - diamondSize},${diamondY}`}
        fill={stroke}
        stroke={wfConditionDiamond.stroke}
        strokeWidth={wfConditionDiamond.strokeWidth}
      />
      <text
        x={diamondX}
        y={diamondY + 4}
        textAnchor="middle"
        fill="white"
        fontSize="10"
        fontWeight="bold"
      >
        ?
      </text>

      <path d={fromDiamond} stroke={stroke} strokeWidth="2" fill="none" markerEnd={markerEnd} />
    </>
  );
}

/* ============================== JSON <-> INTERNAL ============================== */
function buildInternalFromDiagram(diagram) {
  const rawNodes = Array.isArray(diagram?.nodes) ? diagram.nodes : [];
  const rawEdges = Array.isArray(diagram?.edges) ? diagram.edges : [];

  const internal = rawNodes.map((n) => {
    const { gridX, gridY } = pixelToGrid(n.x ?? 0, n.y ?? 0);
    const pos = gridToPixel(gridX, gridY);

    return {
      id: n.id,
      type: "process",
      position: pos,
      data: {
        label: n.title || "Step",
        subtitle: n.subtitle || "",
        detail: n.detail || "",
        gridX,
        gridY,
        connections: [],
        isStart: n.type === "start",
        isEnd: n.type === "end",
        w: n.w ?? 260,
        h: n.h ?? 80
      }
    };
  });

  const byId = new Map(internal.map((n) => [n.id, n]));

  rawEdges.forEach((e) => {
    const from = byId.get(e.from);
    if (!from) return;
    from.data.connections.push({
      targetId: e.to,
      type: e.type || CONNECTION_TYPES.SERIES,
      label: e.label || ""
    });
  });

  return internal;
}

function exportDiagramFromInternal(internalNodes, viewport) {
  const nodes = internalNodes.map((n) => ({
    id: n.id,
    type: n.data.isStart ? "start" : n.data.isEnd ? "end" : undefined,
    x: Math.round(n.position.x),
    y: Math.round(n.position.y),
    w: n.data.w ?? 260,
    h: n.data.h ?? 80,

    // ✅ persisted node fields
    title: n.data.label || "Step",
    subtitle: n.data.subtitle || "",
    detail: n.data.detail || ""
  }));

  const edges = [];
  internalNodes.forEach((n) => {
    (n.data.connections || []).forEach((c) => {
      edges.push({
        id: `${n.id}-${c.targetId}`,
        from: n.id,
        to: c.targetId,
        type: c.type || CONNECTION_TYPES.SERIES,
        label: c.label || ""
      });
    });
  });

  return {
    nodes,
    edges,
    zoom: viewport?.zoom ?? 1,
    pan: { x: viewport?.x ?? 60, y: viewport?.y ?? 60 }
  };
}

/* ============================== EDITOR (STRICT LAYOUT, NO DRAG) ============================== */
const WorkflowFlowEditor = forwardRef(function WorkflowFlowEditor(
  { workflowId, initialDiagram },
  ref
) {
  const rf = useReactFlow();

  const [nodes, setNodes] = useState(() => buildInternalFromDiagram(initialDiagram));

  const [editingEdgeId, setEditingEdgeId] = useState(null);
  const [editingValue, setEditingValue] = useState("");

  // ✅ pinned popover id
  const [pinnedNodeId, setPinnedNodeId] = useState(null);

  useEffect(() => {
    setNodes(buildInternalFromDiagram(initialDiagram));
    setEditingEdgeId(null);
    setPinnedNodeId(null);

    const z = initialDiagram?.zoom ?? 1;
    const p = initialDiagram?.pan ?? { x: 60, y: 60 };
    rf.setViewport({ x: p.x ?? 60, y: p.y ?? 60, zoom: z }, { duration: 0 });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [workflowId]);

  const onUpdateLabel = useCallback((nodeId, label) => {
    setNodes((prev) =>
      prev.map((n) => (n.id === nodeId ? { ...n, data: { ...n.data, label } } : n))
    );
  }, []);

  const onUpdateSubtitle = useCallback((nodeId, subtitle) => {
    setNodes((prev) =>
      prev.map((n) => (n.id === nodeId ? { ...n, data: { ...n.data, subtitle } } : n))
    );
  }, []);

  const onUpdateDetail = useCallback((nodeId, detail) => {
    setNodes((prev) =>
      prev.map((n) => (n.id === nodeId ? { ...n, data: { ...n.data, detail } } : n))
    );
  }, []);

  const onDeleteNode = useCallback((nodeId) => {
    setNodes((prev) => {
      const filtered = prev.filter((n) => n.id !== nodeId);
      return filtered.map((n) => ({
        ...n,
        data: {
          ...n.data,
          connections: (n.data.connections || []).filter((c) => c.targetId !== nodeId)
        }
      }));
    });

    setPinnedNodeId((cur) => (cur === nodeId ? null : cur));
  }, []);

  const pushNodesDown = useCallback((fromGridY, excludeIds = []) => {
    setNodes((prev) =>
      prev.map((n) => {
        if (excludeIds.includes(n.id)) return n;
        const gy = n.data.gridY ?? 0;
        const gx = n.data.gridX ?? 0;
        if (gy >= fromGridY) {
          const nextGY = gy + 1;
          return {
            ...n,
            position: gridToPixel(gx, nextGY),
            data: { ...n.data, gridY: nextGY }
          };
        }
        return n;
      })
    );
  }, []);

  const addConnection = useCallback(
    (sourceNodeId, connectionType) => {
      const source = nodes.find((n) => n.id === sourceNodeId);
      if (!source) return;

      const newNodeId = uuidv4();
      const existing = source.data.connections || [];

      const countByType = (type) =>
        existing.filter(
          (c) =>
            c.type === type ||
            (type === CONNECTION_TYPES.SERIES && c.type === CONNECTION_TYPES.DECISION)
        ).length;

      let gridX = source.data.gridX ?? 0;
      let gridY = source.data.gridY ?? 0;
      let pushFrom = null;

      switch (connectionType) {
        case CONNECTION_TYPES.ROUTE: {
          const routeCount = countByType(CONNECTION_TYPES.ROUTE);
          gridX = (source.data.gridX ?? 0) - 2;
          gridY = (source.data.gridY ?? 0) + routeCount;
          if (routeCount > 0) pushFrom = gridY;
          break;
        }

        case CONNECTION_TYPES.CONDITION: {
          const conditionCount = countByType(CONNECTION_TYPES.CONDITION);
          gridX = (source.data.gridX ?? 0) + 2;
          gridY = (source.data.gridY ?? 0) + 1 + conditionCount;
          pushFrom = gridY;
          break;
        }

        case CONNECTION_TYPES.SUBSTEP: {
          const subCount = countByType(CONNECTION_TYPES.SUBSTEP);
          gridX = (source.data.gridX ?? 0) + 1;
          gridY = (source.data.gridY ?? 0) + 1 + subCount;
          pushFrom = gridY;
          break;
        }

        case CONNECTION_TYPES.SERIES: {
          const seriesCount = countByType(CONNECTION_TYPES.SERIES);
          gridX = (source.data.gridX ?? 0) + 2;

          if (seriesCount === 0) {
            gridY = source.data.gridY ?? 0;
          } else {
            gridY = (source.data.gridY ?? 0) + seriesCount;
            pushFrom = gridY;
          }
          break;
        }

        case CONNECTION_TYPES.PARALLEL: {
          const parCount = countByType(CONNECTION_TYPES.PARALLEL);
          const substepCount = countByType(CONNECTION_TYPES.SUBSTEP);

          gridX = source.data.gridX ?? 0;
          gridY = (source.data.gridY ?? 0) + 1 + substepCount + parCount;
          pushFrom = gridY;
          break;
        }

        default:
          break;
      }

      const existingSeriesConnections = existing.filter(
        (c) => c.type === CONNECTION_TYPES.SERIES || c.type === CONNECTION_TYPES.DECISION
      );

      let actualType = connectionType;
      let connectionLabel = "";

      if (connectionType === CONNECTION_TYPES.SERIES && existingSeriesConnections.length > 0) {
        actualType = CONNECTION_TYPES.DECISION;
        connectionLabel = `Option ${existingSeriesConnections.length + 1}`;
      }

      if (pushFrom !== null) pushNodesDown(pushFrom, [sourceNodeId]);

      const newPos = gridToPixel(gridX, gridY);

      setNodes((prev) => {
        let updated = [...prev];

        if (connectionType === CONNECTION_TYPES.SERIES && existingSeriesConnections.length > 0) {
          updated = updated.map((n) => {
            if (n.id !== sourceNodeId) return n;
            return {
              ...n,
              data: {
                ...n.data,
                connections: (n.data.connections || []).map((c) =>
                  c.type === CONNECTION_TYPES.SERIES
                    ? { ...c, type: CONNECTION_TYPES.DECISION, label: c.label || "Option 1" }
                    : c
                )
              }
            };
          });
        }

        updated = updated.map((n) => {
          if (n.id !== sourceNodeId) return n;
          return {
            ...n,
            data: {
              ...n.data,
              connections: [
                ...(n.data.connections || []),
                { targetId: newNodeId, type: actualType, label: connectionLabel }
              ]
            }
          };
        });

        updated.push({
          id: newNodeId,
          type: "process",
          position: newPos,
          data: {
            label: "Step",
            subtitle: "",
            detail: "",
            gridX,
            gridY,
            connections: [],
            isStart: false,
            isEnd: false,
            w: 260,
            h: 80
          }
        });

        return updated;
      });
    },
    [nodes, pushNodesDown]
  );

  const edges = useMemo(() => {
    const all = [];
    const bySourceDecisionCount = new Map();

    nodes.forEach((n) => {
      (n.data.connections || []).forEach((conn) => {
        const id = `${n.id}-${conn.targetId}`;
        const stroke = wfGetEdgeStroke(conn.type);
        const { sourceHandle, targetHandle } = getHandlesForType(conn.type);

        const markerEnd =
          conn.type === CONNECTION_TYPES.PARALLEL
            ? undefined
            : { type: MarkerType.ArrowClosed, width: 16, height: 16, color: stroke };

        let showDiamond = false;
        if (conn.type === CONNECTION_TYPES.DECISION) {
          const c = bySourceDecisionCount.get(n.id) ?? 0;
          showDiamond = c === 0;
          bySourceDecisionCount.set(n.id, c + 1);
        }

        all.push({
          id,
          source: n.id,
          target: conn.targetId,
          sourceHandle,
          targetHandle,
          type: conn.type,
          markerEnd,
          data: {
            label: conn.label || "",
            showDiamond,
            setEditingEdgeId
          }
        });
      });
    });

    return all;
  }, [nodes]);

  const updateEdgeLabel = useCallback((edgeId, newLabel) => {
    const parts = edgeId.split("-");
    const sourceId = parts[0];
    const targetId = parts.slice(1).join("-");

    setNodes((prev) =>
      prev.map((n) => {
        if (n.id !== sourceId) return n;
        return {
          ...n,
          data: {
            ...n.data,
            connections: (n.data.connections || []).map((c) =>
              c.targetId === targetId ? { ...c, label: newLabel } : c
            )
          }
        };
      })
    );
  }, []);

  useEffect(() => {
    if (!editingEdgeId) return;
    const edge = edges.find((e) => e.id === editingEdgeId);
    setEditingValue(edge?.data?.label ?? "");
  }, [editingEdgeId, edges]);

  const nodeTypes = useMemo(() => ({ process: ProcessNode }), []);
  const edgeTypes = useMemo(
    () => ({
      [CONNECTION_TYPES.SERIES]: SeriesEdge,
      [CONNECTION_TYPES.DECISION]: DecisionEdge,
      [CONNECTION_TYPES.ROUTE]: RouteEdge,
      [CONNECTION_TYPES.SUBSTEP]: SubStepEdge,
      [CONNECTION_TYPES.PARALLEL]: ParallelEdge,
      [CONNECTION_TYPES.CONDITION]: ConditionEdge
    }),
    []
  );

  const nodesWithCallbacks = useMemo(() => {
    return nodes.map((n) => ({
      ...n,
      style: { width: GRID.NODE_WIDTH, height: GRID.NODE_HEIGHT },
      data: {
        ...n.data,

        // ✅ pin logic
        isPinned: pinnedNodeId === n.id,

        // ✅ callbacks
        onAddConnection: addConnection,
        onUpdateLabel,
        onUpdateSubtitle,
        onUpdateDetail,
        onDeleteNode
      }
    }));
  }, [nodes, pinnedNodeId, addConnection, onUpdateLabel, onUpdateSubtitle, onUpdateDetail, onDeleteNode]);

  useImperativeHandle(ref, () => ({
    ensureStartNodeIfEmpty() {
      setNodes((prev) => {
        if (prev.length) return prev;
        const startGX = 3;
        const startGY = 1;
        return [
          {
            id: "start",
            type: "process",
            position: gridToPixel(startGX, startGY),
            data: {
              label: "Start",
              subtitle: "",
              detail: "",
              gridX: startGX,
              gridY: startGY,
              connections: [],
              isStart: true,
              isEnd: false,
              w: 260,
              h: 80
            }
          }
        ];
      });
    },
    exportDiagram() {
      const vp = rf.getViewport();
      return exportDiagramFromInternal(nodesWithCallbacks, vp);
    }
  }));

  return (
    <>
      <ReactFlow
        nodes={nodesWithCallbacks}
        edges={edges}
        nodeTypes={nodeTypes}
        edgeTypes={edgeTypes}
        nodesDraggable={false}
        nodesConnectable={false}
        elementsSelectable={false} // ✅ we control "selection" via pinned state
        fitView={false}
        defaultViewport={{ x: 60, y: 60, zoom: 1 }}

        // ✅ LEFT CLICK panning
        panOnDrag={true}
        panActivationKeyCode={null}
        selectionOnDrag={false}

        // ✅ pin / unpin behavior
        onNodeClick={(_, node) => setPinnedNodeId(node?.id || null)}
        onPaneClick={() => setPinnedNodeId(null)}

        className="bg-transparent"
      >
        <Background
          gap={wfBackgroundGrid.gap}
          size={wfBackgroundGrid.size}
          color={wfBackgroundGrid.color}
        />

        {editingEdgeId ? (
          <EdgeLabelRenderer>
            <div
              className="absolute left-4 top-4 z-[999] rounded-xl border border-zinc-200/80 bg-white p-3 shadow-[0_1px_0_rgba(0,0,0,0.05),0_20px_50px_rgba(0,0,0,0.12)]"
              style={{ pointerEvents: "all" }}
            >
              <div className="mb-2 text-xs font-semibold text-zinc-800">Edit decision label</div>
              <input
                autoFocus
                value={editingValue}
                onChange={(e) => setEditingValue(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    updateEdgeLabel(editingEdgeId, editingValue);
                    setEditingEdgeId(null);
                  }
                  if (e.key === "Escape") setEditingEdgeId(null);
                }}
                onBlur={() => {
                  updateEdgeLabel(editingEdgeId, editingValue);
                  setEditingEdgeId(null);
                }}
                className="w-64 rounded-xl border border-zinc-200/80 bg-white px-3 py-2 text-sm text-zinc-900 outline-none"
              />
              <div className="mt-2 text-[11px] text-zinc-500">Enter to save • Esc to cancel</div>
            </div>
          </EdgeLabelRenderer>
        ) : null}
      </ReactFlow>

      <div className={wfHintOverlayClass}>
        💡 Click a node to edit details • Click icons to add connections • Drag to pan
      </div>
    </>
  );
});

/* ============================== MEMOIZED DIAGRAM CONTAINER ============================== */
const DiagramContainer = memo(
  forwardRef(function DiagramContainer({ workflowId, initialDiagram, height }, ref) {
    return (
      <div
        className="relative rounded-2xl border border-zinc-200/80 bg-[#fbfbfa] overflow-hidden"
        style={{ height }}
      >
        <ReactFlowProvider>
          <WorkflowFlowEditor
            ref={ref}
            workflowId={workflowId}
            initialDiagram={initialDiagram}
          />
        </ReactFlowProvider>
      </div>
    );
  }),
  (prevProps, nextProps) => prevProps.workflowId === nextProps.workflowId
);

/* ============================== MAIN WORKFLOWS VIEW ============================== */
export default function Workflows() {
  const {
    workflows,
    selectedWorkflowId,
    setSelectedWorkflowId,
    createWorkflow,
    updateWorkflowLocal,
    deleteWorkflow
  } = useDFMEA();

  const activeWorkflow = useMemo(
    () => workflows.find((w) => w.id === selectedWorkflowId) || null,
    [workflows, selectedWorkflowId]
  );

  const [viewMode, setViewMode] = useState("diagram");
  const [saving, setSaving] = useState(false);
  const [savedToast, setSavedToast] = useState(false);

  const editorRef = useRef(null);

  useEffect(() => {
    setViewMode("diagram");
    setSavedToast(false);
  }, [activeWorkflow?.id]);

  async function saveLayout() {
    if (!activeWorkflow || saving) return;

    setSaving(true);
    setSavedToast(false);

    try {
      const diagram = editorRef.current?.exportDiagram?.();
      if (!diagram) throw new Error("No diagram export available");

      updateWorkflowLocal(activeWorkflow.id, { diagram });

      const res = await fetch("/api/workflows/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workflowId: activeWorkflow.id,
          diagram,
          meta: {
            title: activeWorkflow.title,
            summary: activeWorkflow.summary,
            category: activeWorkflow.category,
            owner: activeWorkflow.owner,
            textSteps: activeWorkflow.textSteps
          }
        })
      });

      const j = await res.json();
      if (!j?.ok) throw new Error(j?.error || "Save failed");

      if (j?.workflow?.id) {
        updateWorkflowLocal(j.workflow.id, j.workflow);
      }

      setSavedToast(true);
      setTimeout(() => setSavedToast(false), 1400);
    } catch (err) {
      console.error(err);
      alert(`Save failed: ${err?.message || "unknown error"}`);
    } finally {
      setSaving(false);
    }
  }

  function addStep() {
    editorRef.current?.ensureStartNodeIfEmpty?.();
  }

  function handleDeleteActiveWorkflow() {
    if (!activeWorkflow) return;

    const ok = window.confirm(
      `Delete workflow "${activeWorkflow.title?.trim() ? activeWorkflow.title : "Untitled workflow"}"?`
    );
    if (!ok) return;

    deleteWorkflow?.(activeWorkflow.id);
  }

  const diagramHeight = "calc(100vh - 170px)";

  const EmptyState = () => (
    <div className="rounded-2xl border border-zinc-200/80 bg-white p-10 shadow-[0_1px_0_rgba(0,0,0,0.05),0_14px_40px_rgba(0,0,0,0.06)]">
      <div className="text-[16px] font-semibold tracking-tight text-zinc-900">
        No workflow selected
      </div>
      <div className="mt-1 text-[13px] text-zinc-600">
        Create a workflow from the sidebar, then start building your diagram.
      </div>

      <button
        onClick={() => createWorkflow()}
        className="mt-5 inline-flex items-center gap-2 rounded-xl bg-zinc-900 px-4 py-2 text-[13px] font-medium text-white hover:bg-zinc-800"
      >
        <Plus size={16} strokeWidth={1.8} />
        Create workflow
      </button>
    </div>
  );

  const TextView = () => (
    <div className="rounded-2xl border border-zinc-200/80 bg-white shadow-[0_1px_0_rgba(0,0,0,0.05),0_14px_40px_rgba(0,0,0,0.06)] p-6">
      <div className="text-[13px] font-semibold tracking-tight text-zinc-900">
        {activeWorkflow?.title || "Untitled workflow"}
      </div>
      <div className="mt-1 text-[12px] text-zinc-600 tracking-tight">
        {activeWorkflow?.summary || "No summary yet."}
      </div>
    </div>
  );

  return (
    <div className="px-6 pt-4 pb-8 w-full">
      {/* top bar */}
      <div className="flex items-center justify-between gap-3">
        <div className="flex items-center gap-3 min-w-0">
          <div className="text-[18px] font-semibold tracking-tight text-zinc-900">
            Workflows
          </div>

          <select
            value={selectedWorkflowId || ""}
            onChange={(e) => setSelectedWorkflowId(e.target.value || "")}
            className="text-[13px] px-3 py-2 rounded-xl bg-white border border-zinc-200/80 outline-none min-w-[320px]"
          >
            <option value="">Select workflow…</option>
            {workflows.map((w) => (
              <option key={w.id} value={w.id}>
                {w.title?.trim() ? w.title : "Untitled workflow"}
              </option>
            ))}
          </select>

          {savedToast ? (
            <span className="text-[11px] px-2 py-1 rounded-full bg-emerald-50 border border-emerald-200/70 text-emerald-900">
              Saved ✓
            </span>
          ) : null}
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={addStep}
            disabled={!activeWorkflow}
            className={cx(
              "text-[12px] px-3 py-2 rounded-xl border transition-colors inline-flex items-center gap-2",
              activeWorkflow
                ? "bg-white border-zinc-200/80 hover:bg-zinc-100 text-zinc-800"
                : "bg-zinc-100 border-zinc-200/80 text-zinc-400 cursor-not-allowed"
            )}
            title="Creates Start node only if empty"
          >
            <Plus size={16} strokeWidth={1.8} />
            Add step
          </button>

          <button
            onClick={saveLayout}
            disabled={!activeWorkflow || saving}
            className={cx(
              "text-[12px] px-3 py-2 rounded-xl inline-flex items-center gap-2 transition-colors",
              activeWorkflow && !saving
                ? "bg-zinc-900 text-white hover:bg-zinc-800"
                : "bg-zinc-200 text-zinc-500 cursor-not-allowed"
            )}
          >
            <Save size={16} strokeWidth={1.8} />
            {saving ? "Saving..." : "Save"}
          </button>

          <button
            onClick={handleDeleteActiveWorkflow}
            disabled={!activeWorkflow}
            className={cx(
              "text-[12px] px-3 py-2 rounded-xl border transition-colors inline-flex items-center gap-2",
              activeWorkflow
                ? "bg-white border-zinc-200/80 hover:bg-amber-50 text-amber-900"
                : "bg-zinc-100 border-zinc-200/80 text-zinc-400 cursor-not-allowed"
            )}
            title="Delete selected workflow"
          >
            <Trash2 size={16} strokeWidth={2} />
            Delete
          </button>

          <button
            onClick={() => setViewMode("diagram")}
            className={cx(
              "text-[12px] px-3 py-2 rounded-xl border transition-colors inline-flex items-center gap-2",
              viewMode === "diagram"
                ? "bg-zinc-900 text-white border-zinc-900"
                : "bg-white text-zinc-700 border-zinc-200/80 hover:bg-zinc-100"
            )}
          >
            <WorkflowIcon size={16} strokeWidth={1.8} />
            Diagram
          </button>

          <button
            onClick={() => setViewMode("text")}
            className={cx(
              "text-[12px] px-3 py-2 rounded-xl border transition-colors inline-flex items-center gap-2",
              viewMode === "text"
                ? "bg-zinc-900 text-white border-zinc-900"
                : "bg-white text-zinc-700 border-zinc-200/80 hover:bg-zinc-100"
            )}
          >
            <List size={16} strokeWidth={1.8} />
            Text
          </button>
        </div>
      </div>

      {/* rename inputs */}
      {activeWorkflow ? (
        <div className="mt-3 grid grid-cols-12 gap-3">
          <div className="col-span-7">
            <div className="text-[11px] text-zinc-500 tracking-tight">Workflow title</div>
            <input
              value={activeWorkflow.title || ""}
              onChange={(e) =>
                updateWorkflowLocal(activeWorkflow.id, { title: e.target.value })
              }
              className="mt-1 w-full rounded-xl border border-zinc-200/80 bg-white px-3 py-2
                         text-[13px] tracking-tight text-zinc-900 outline-none
                         focus:ring-2 focus:ring-zinc-300"
              placeholder="e.g. DFMEA release gate workflow"
            />
          </div>

          <div className="col-span-5">
            <div className="text-[11px] text-zinc-500 tracking-tight">Summary</div>
            <input
              value={activeWorkflow.summary || ""}
              onChange={(e) =>
                updateWorkflowLocal(activeWorkflow.id, { summary: e.target.value })
              }
              className="mt-1 w-full rounded-xl border border-zinc-200/80 bg-white px-3 py-2
                         text-[13px] tracking-tight text-zinc-900 outline-none
                         focus:ring-2 focus:ring-zinc-300"
              placeholder="Short description..."
            />
          </div>
        </div>
      ) : null}

      <div className="mt-3">
        {!activeWorkflow ? (
          <EmptyState />
        ) : viewMode === "diagram" ? (
          <DiagramContainer
            ref={editorRef}
            workflowId={activeWorkflow.id}
            initialDiagram={
              activeWorkflow.diagram || {
                nodes: [],
                edges: [],
                zoom: 1,
                pan: { x: 60, y: 60 }
              }
            }
            height={diagramHeight}
          />
        ) : (
          <TextView />
        )}
      </div>
    </div>
  );
}


==========================================================================================
FILE: components/Workspace.js
==========================================================================================
// components/Workspace.js
"use client";

import { useEffect, useLayoutEffect, useMemo, useRef, useState } from "react";
import { FileText, GitBranch, Search as SearchIcon, Workflow } from "lucide-react";

import RequirementsViewport from "./RequirementsViewport";
import ProcessDiagramViewport from "./ProcessDiagramViewport";
import RootCauseViewport from "./RootCauseViewport";
import Workflows from "./Workflows";
import AiDock from "./AiDock";

const cx = (...c) => c.filter(Boolean).join(" ");

export default function Workspace({
  tabData,
  onUpdateRequirements,
  requirementsUnlocked,
  onListViewUnlock,
  selectedWorkflowId,
  onSelectWorkflowId
}) {
  const isWorkflows = tabData.tabId === "workflows";

  const Viewport = useMemo(() => {
    if (tabData.tabId === "requirements") return RequirementsViewport;
    if (tabData.tabId === "processDiagram") return ProcessDiagramViewport;
    if (tabData.tabId === "workflows") return Workflows;
    return RootCauseViewport;
  }, [tabData.tabId]);

  const Icon = useMemo(() => {
    if (tabData.tabId === "requirements") return FileText;
    if (tabData.tabId === "processDiagram") return GitBranch;
    if (tabData.tabId === "workflows") return Workflow;
    return SearchIcon;
  }, [tabData.tabId]);

  const dockRef = useRef(null);
  const [dockHeight, setDockHeight] = useState(0);

  const [enter, setEnter] = useState(false);
  useEffect(() => {
    setEnter(false);
    const id = requestAnimationFrame(() => setEnter(true));
    return () => cancelAnimationFrame(id);
  }, [tabData.tabId]);

  useLayoutEffect(() => {
    if (!dockRef.current) return;
    const el = dockRef.current;

    const ro = new ResizeObserver((entries) => {
      const h = Math.ceil(entries[0].contentRect.height);
      setDockHeight(h);
    });

    ro.observe(el);
    return () => ro.disconnect();
  }, []);

  return (
    <div className="flex-1 overflow-hidden bg-[#fbfbfa]">
      <div className="h-full flex flex-col">
        {/* header */}
        <div className="h-12 px-6 flex items-center justify-between bg-[#fbfbfa] border-b border-zinc-200/70">
          <div className="flex items-center gap-2 min-w-0">
            <Icon size={18} strokeWidth={1.6} className="text-zinc-700" />
            <div className="text-[13px] font-semibold tracking-tight text-zinc-900 truncate">
              {tabData.title}
            </div>
            <div className="text-[11px] text-zinc-500 whitespace-nowrap">
              • {tabData.meta.visibility}
            </div>
          </div>
          <div className="text-[11px] text-zinc-500 whitespace-nowrap">{tabData.meta.edited}</div>
        </div>

        <div className="relative flex-1 overflow-hidden">
          {/* ✅ Workflows = NO scroll container */}
          {isWorkflows ? (
            <div className="h-full">
              <div
                className={cx(
                  "h-full transition-opacity duration-200",
                  enter ? "opacity-100" : "opacity-0"
                )}
              >
                <Viewport
                  data={tabData}
                  selectedWorkflowId={selectedWorkflowId}
                  onSelectWorkflowId={onSelectWorkflowId}
                />
              </div>
            </div>
          ) : (
            <>
              {/* normal scroll pages */}
              <div
                className="h-full overflow-y-auto"
                style={{ paddingBottom: dockHeight ? dockHeight + 28 : 320 }}
              >
                <div
                  className={cx(
                    "transition-opacity duration-200",
                    enter ? "opacity-100" : "opacity-0"
                  )}
                >
                  <Viewport
                    data={tabData}
                    onUpdateRequirements={onUpdateRequirements}
                    requirementsUnlocked={requirementsUnlocked}
                    onListViewUnlock={onListViewUnlock}
                  />
                </div>

                <div className="h-10" />
              </div>

              {/* fades only for normal pages */}
              <div
                aria-hidden="true"
                className="pointer-events-none absolute top-0 left-0 right-0 h-10 bg-gradient-to-b from-[#fbfbfa] to-transparent"
              />
              <div
                aria-hidden="true"
                className="pointer-events-none absolute bottom-0 left-0 right-0 h-28 bg-gradient-to-t from-[#fbfbfa] to-transparent"
              />
            </>
          )}

          {/* AI dock always pinned */}
          <div className="absolute left-0 right-0 bottom-0">
            <div className="px-8 pb-6">
              <div ref={dockRef}>
                <AiDock tabData={tabData} />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
